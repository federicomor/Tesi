---
title: "R Notebook"
output: html_document
---

# JuliaConnectoR (better)
```{r}
library(JuliaConnectoR)
juliaSetupOk()

# setup project
juliaEval("using Pkg; Pkg.status()")
juliaEval("Pkg.activate(\"../../JDRPM\")")
juliaEval("using Pkg; Pkg.status()")

# examples
# which we dont need if we activate the project
# juliaEval("using Random; Random.seed!(5);")
# juliaEval("using Statistics")
# juliaEval("using Logging")
# juliaEval("using Distributions")
# juliaEval("rand(Beta(10,10))")
```

```{r}
# Importing a module without a package
getwd()
testModule = normalizePath("../../JDRPM/src/JDRPM.jl")
cat(testModule)
# take a look at the file
# writeLines(readLines(testModule))
# load in Julia
# juliaCall("include", testModule)
# import in R via relative module path
# TestModule1 <- juliaImport(".JDRPM")

# Importing a local module is also possible in one line,
# by directly using the module object returned by "include".
TestModule1 <- juliaImport(juliaCall("include", testModule))
x = TestModule1$my_example(30)

n = 5
bigT = 3
p = 2
# nxbigT matrix of normally distributed random numbers
Y <- matrix(rnorm(n * bigT), nrow = n, ncol = bigT)
# nx3xbigT array of normally distributed random numbers
X_covariates <- array(rnorm(n * p * bigT), dim = c(n, p, bigT))
# nx2 matrix of uniformly distributed random numbers between 0 and 1
sp_coords <- matrix(runif(n * 2), nrow = n, ncol = 2)
```


```{r}
seed_choice = round(runif(1,0,1000))
set.seed(seed_choice)
```

## fit

```{r}
TestModule1 <- juliaImport(juliaCall("include", testModule))
out = TestModule1$MCMC_fit(
	Y=Y,              
	sp_coords = sp_coords,             
	Xlk_covariates = X_covariates,
	# Xcl_covariates = ,
	M_dp = 19,                     
	# initial_partition = NA,     
	starting_alpha = 0.5,         
	
	unit_specific_alpha = FALSE,       
	time_specific_alpha = TRUE,       
	update_alpha = TRUE,             
	
	include_eta1 = TRUE,                    
	include_phi1 = TRUE,
	update_eta1 = TRUE,                    
	update_phi1 = TRUE,
	
	sig2h_priors = c(3,1),
	eta1_priors = c(1,2),
	beta_priors = c(rep(1,p),2),
	tau2_priors = c(1,2),
	phi0_priors = c(1,2),
	phi1_priors = 2,
	lambda2_priors = c(1,2),
	alpha_priors = c(1,1),  
	
	spatial_cohesion_idx = 1,
	sp_params = 0.5,
	# sp_params = c(0.5,1),
	# spatial_cohesion_idx = 3,
	# sp_params = list(c(1,2),1,2,matrix(c(1,2,2,4),nrow=2)),
	
	# covariate_similarity_idx = NA,  
	draws = 78,                    
	burnin = 60,                   
	thin = 2,                     
	verbose = TRUE,
	seed = seed_choice
)
```

## explore output
```{r}
rout = juliaGet(out)
names(rout)  = c("Si_out",
				 "gamma_out",
				 "alpha_out", 
				 "sigma2h_out", 
				 "muh_out", 
				 "eta1_iter",
				 "beta_out",
				 "theta_out", 
				 "tau2_out", 
				 "phi0_out", 
				 "phi1_out",
				 "lambda2_out",
				 "fitted",
				 "llike",
				 "lpml",
				 "waic")

# reshape some stuff to uniform it to drpm output
rout$Si_out       = aperm(rout$Si_out,       c(2, 1, 3))
rout$gamma_out    = aperm(rout$gamma_out,    c(2, 1, 3))
rout$sigma2h_out  = aperm(rout$sigma2h_out,  c(2, 1, 3))
rout$muh_out      = aperm(rout$muh_out,      c(2, 1, 3))
rout$alpha_out    = aperm(rout$alpha_out,    c(2, 1))
rout$theta_out    = aperm(rout$theta_out,    c(2, 1))
rout$tau2_out     = aperm(rout$tau2_out,     c(2, 1))
rout$eta1_iter    = aperm(rout$eta1_iter,    c(2, 1))
rout$phi0_out     = matrix(rout$phi0_out,    ncol = 1)
rout$phi1_out     = matrix(rout$phi1_out,    ncol = 1)
rout$lambda2_out  = matrix(rout$lambda2_out, ncol = 1)
```




```{r}
cat("Si_out       size = ",size(rout$Si_out),"\n")
cat("gamma_out    size = ",size(rout$gamma_out),"\n")
cat("sigma2h_out  size = ",size(rout$sigma2h_out),"\n")
cat("muh_out      size = ",size(rout$muh_out),"\n")
cat("alpha_out    size = ",size(rout$alpha_out),"\n")
cat("theta_out    size = ",size(rout$theta_out),"\n")
cat("tau2_out     size = ",size(rout$tau2_out),"\n")
cat("eta1_iter    size = ",size(rout$eta1_iter),"\n")
cat("phi0_out     size = ",size(rout$phi0_out),"\n")
cat("phi1_out     size = ",size(rout$phi1_out),"\n")
cat("lambda2_out  size = ",size(rout$lambda2_out),"\n")
cat("beta_out     size = ",size(rout$beta_out),"\n")
cat("fitted       size = ",size(rout$fitted),"\n")
cat("llike        size = ",size(rout$llike),"\n")
```


```{r}
par(mar=c(4,2,2,2))
for (time in 1:bigT) {
	plot(rout$alpha_out[time,],
		 ylim=c(0,1),
		 type="l",
		 xlab="iterates",
		 ylab="",
		 main=bquote("Trace plot of " * alpha[.(time)] ))
}
```
# muh
```{r}
subject = 1
for (time in 1:bigT){
	plot(rout$muh_out[subject,time,],type="l",
		 main=bquote("Trace plot of " * mu * " at time " * .(time) * 
		 				" - subject " * .(subject)),
		 xlab = "MCMC iterations",ylab="values")
}
for (time in time_span_plot){
	par(mar=c(4,4,3,2))
	acf(drpm1$mu[time,sampled_station,],main=bquote("ACF plot of " * mu * " at week " * .(time) * 
		 				" - station " * .(sampled_station_name)))
}
```


## close log
```{r}
TestModule1$close_log_file()
```









