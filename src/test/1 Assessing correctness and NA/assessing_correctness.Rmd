---
title: "R Notebook"
output: html_document
---

# setup
```{r, warning=FALSE}
library(salso)
library(RColorBrewer)
source("../include.R")
```



# LOAD 
## load C drpm
```{r}
devtools::load_all("../../drpm_main/")
# devtools::load_all("../../drpm_sporcato//")
```

## load J drpm
```{r}
library(JuliaConnectoR)
juliaSetupOk()

# juliaEval("using Pkg")
# juliaEval("Pkg.activate(\"../../JDRPM\")")
# juliaEval("Pkg.instantiate()")

# juliaEval("Pkg.status()")
# setup project
juliaEval("using Pkg; Pkg.status()")
juliaEval("Pkg.activate(\"../../JDRPM\")")
juliaEval("using Pkg; Pkg.status()")

module = normalizePath("../../JDRPM/src/JDRPM.jl")
module_JDRPM <- juliaImport(juliaCall("include", module))

module_JDRPM$trigger_compilation()
```


# ===========
# 1. PAPER TEST
## data used in Page paper
```{r}
seed = as.integer(runif(1,0,1000))*1.0
seed = 398.0
# seed = 398.0
# seed = 881.0
set.seed(seed)
cat(seed)

source("../Supplementary material/Functions.R")
# N <- 5; Tm<-6; M<-1;
# alpha = 0.99

# N <- 4; Tm<-7; M<-1;
# alpha = 0.9

N <- 10; Tm<-12; M<-1;
alpha = 0.9

# N <- 20; Tm<-20; M<-1;
# set.seed(345233)
# alpha = 0.8

ndata <- 100
dat <- rtpartition1(N=N,M=M,rho=alpha,ntime=Tm,tau=5,sig=1,
					Caron=FALSE,FirstPart=NULL,TYPE="Random",
				    phi0=0, phi1=1)

y<- t(dat$YMat)

cols = colora(N,seed = 56,show = 0)
yred=y
cols = colora(size(yred)[1],56,0)
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],ylim=extrema(yred),type='l',xlab='weeks',ylab='pm10')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}
```

## introduce NA test
```{r}
##### at a new time 7
# y_with_na = cbind(y,rep(NA,5))
# y
# y_with_na
# module_JDRPM$test_R_to_J_conversion(as.matrix(y_with_na))

##### deleting values at existent time t, to maybe study MSE
t = 4
y_with_na = y
y_with_na[,t] = rep(NA,5)

##### just some NA
y_with_na = y
y_with_na[3,3] = NA
y_with_na[1,2] = NA
y_with_na[5,5] = NA

y
y_with_na
```


## Fits
```{r}
# niter=40000; nburn=28000; nthin=12
# niter=50000; nburn=30000; nthin=20
# niter=30000; nburn=20000; nthin=10
niter=10000; nburn=5000; nthin=5 #OFFICIAL ONE
# niter=30000; nburn=20000; nthin=4
# niter=1000; nburn=200; nthin=4

nout <- (niter-nburn)/nthin
cat(nout,"valid iterations\n")

```


```{r}
# params
m0_phi0 = 0
s20_phi0 = 10
A_ub_sigma = 5
A_ub_tau = 5
A_ub_lambda = 5
a_sigma  = 2; b_sigma  = 2
a_tau    = 2; b_tau    = 1
a_lambda = 2; b_lambda = 2
# a_sigma  = 1.3; b_sigma  = 1.9
# a_tau    = 1.3; b_tau    = 1.9
# a_lambda = 1.3; b_lambda = 1.9
# a_sigma  = 1; b_sigma  = 2
# a_tau    = 1; b_tau    = 2
# a_lambda = 1; b_lambda = 2
# a_sigma  = 0.01; b_sigma  = 0.01
# a_tau    = 1; b_tau    = 2
# a_lambda = 1; b_lambda = 2
eta1_scale = 0.9

sig_mh_sig2 = 0.3
sig_mh_tau2 = 0.3
sig_mh_lambda2 = 0.3
sig_mh_eta1 = 0.1
sig_mh_phi1 = 0.2

update_eta1 = TRUE
update_phi1 = TRUE

mu0 = 0 
k0 = 1
v0 = 5
L0 = 1

a_alpha = 2; b_alpha = 2
```

```{r}
# save(drpm1, rout, file="assessing_correctness_nospace_full_CJ.Rdata")
```


## drpm C
```{r}
set.seed(1)
tempo_inizio <- Sys.time()
drpm1 <- drpm_fit(
		y=y,
		# y=y_with_na, 
		# s_coords = NA,
        M=1,
        initial_partition = NULL,
		
        starting_alpha = 0.5,
        unit_specific_alpha = FALSE,
        time_specific_alpha = TRUE,
        alpha_0=FALSE,
		
        eta1_0=!(update_eta1),
        phi1_0=!(update_phi1),
        # modelPriors=c(0,100^2,1,1,1,1), # original default one
        modelPriors=c(m0_phi0,s20_phi0,A_ub_sigma,A_ub_tau,A_ub_lambda,eta1_scale),

        alphaPriors=rbind(c(a_alpha,b_alpha)), # if time_specific_alpha == TRUE
        
        simpleModel = 0,
        theta_tau2 = c(0, 2), # only used if simpleModel=1

		SpatialCohesion=3, # auxiliary similarity
		# SpatialCohesion=4, # double dipper similarity
		cParms=c(mu0, k0, v0, L0),
		
		mh=c(sig_mh_sig2,sig_mh_tau2,sig_mh_lambda2,sig_mh_eta1,sig_mh_phi1),
		verbose=TRUE,
		draws=niter,burn=nburn,thin=nthin)

tempo_fine <- Sys.time()
differenza_tempo <- tempo_fine - tempo_inizio
cat(crayon::cyan("Fit took:\n"))
print(round(differenza_tempo,digits = 4))

cat(crayon::red("\nLPML =",drpm1$lpml, "\nWAIC =",drpm1$waic))
```
```{r}
names(drpm1)

cat("\nSi     size = ",size(drpm1$Si),"\n")
cat("gamma  size = ",size(drpm1$gamma),"\n")
cat("mu     size = ",size(drpm1$mu),"\n")
cat("sig2   size = ",size(drpm1$sig2),"\n")
cat("alpha  size = ",size(drpm1$alpha),"\n")
cat("theta  size = ",size(drpm1$theta),"\n")
cat("tau2   size = ",size(drpm1$tau2),"\n")
cat("eta1   size = ",size(drpm1$eta1),"\n")
cat("phi0   size = ",size(drpm1$phi0),"\n")
cat("phi1   size = ",size(drpm1$phi1),"\n")
cat("lam2   size = ",size(drpm1$lam2),"\n")
cat("llike  size = ",size(drpm1$llike),"\n")
cat("fitted size = ",size(drpm1$fitted),"\n")
```



## drpm J
```{r}
a_sigma  = 2; b_sigma  = 2
a_tau    = 1.5; b_tau    = 1.5
a_lambda = 1.5; b_lambda = 1.5

# module_JDRPM <- juliaImport(juliaCall("include", module))
out = module_JDRPM$MCMC_fit(
	Y=as.matrix(y),
	# Y=as.matrix(y_with_na),
	sp_coords = NA,
	M_dp = 1,                     
	initial_partition = NA,
	Xlk_covariates = NA,
	Xcl_covariates = NA,
	# initial_partition = c(1,2,1,2,2),
	
	starting_alpha = 0.5,         
	unit_specific_alpha = FALSE,       
	time_specific_alpha = TRUE,       
	update_alpha = TRUE,             
	
	include_eta1 = TRUE,                    
	include_phi1 = TRUE,
	update_eta1 = update_eta1,                    
	update_phi1 = update_phi1,
	
	sig2h_priors = c(a_sigma,b_sigma),
	eta1_priors = c(eta1_scale,sig_mh_eta1),
	# beta_priors = c(rep(1,p),2),
	beta_priors = NA,
	tau2_priors = c(a_tau,b_tau),
	phi0_priors = c(m0_phi0,s20_phi0),
	phi1_priors = sig_mh_phi1,
	lambda2_priors = c(a_lambda,b_lambda),
	alpha_priors = c(a_alpha,b_alpha),  
	
	# spatial_cohesion_idx = 4,
	# sp_params = list(c(1,2),1,2,matrix(c(1,2,2,4),nrow=2)),
	
	# covariate_similarity_idx = NA,  
	draws = as.integer(niter), burnin = as.integer(nburn),thin = as.integer(nthin),
	# draws = 100000, burnin = 60000,thin = 40,
	logging = FALSE,
	seed = 111.0,
	verbose=T,
	perform_diagnostics = T
)
```



```{r}
rout = juliaGet(out)
names(rout)  = c("Si",
				 "gamma",
				 "alpha", 
				 "sigma2h", 
				 "muh", 
				 "eta1",
				 "beta",
				 "theta", 
				 "tau2", 
				 "phi0", 
				 "phi1",
				 "lambda2",
				 "fitted",
				 "llike",
				 "lpml",
				 "waic")

# reshape some stuff to uniform it to drpm output
rout$Si           = aperm(rout$Si,       c(2, 1, 3))
rout$gamma        = aperm(rout$gamma,    c(2, 1, 3))
rout$sigma2h      = aperm(rout$sigma2h,  c(2, 1, 3))
rout$muh          = aperm(rout$muh,      c(2, 1, 3))
rout$fitted       = aperm(rout$fitted,   c(2, 1, 3))
rout$llike        = aperm(rout$llike,    c(2, 1, 3))
if (is.null(size(rout$alpha))) {
	# do nothing
# } else if size(rout$alpha) == 2 {
} else {
	rout$alpha        = aperm(rout$alpha,    c(2, 1))
}
rout$theta        = aperm(rout$theta,    c(2, 1))
rout$tau2         = aperm(rout$tau2,     c(2, 1))
rout$eta1         = aperm(rout$eta1,    c(2, 1))
rout$phi0     = matrix(rout$phi0,    ncol = 1)
rout$phi1     = matrix(rout$phi1,    ncol = 1)
rout$lambda2  = matrix(rout$lambda2, ncol = 1)
cat(crayon::red("\nLPML =",rout$lpml, "\nWAIC =",rout$waic))
```
```{r}
# save(rout,drpm1,file="nospace_full_CJ.Rdata")
```

```{r}
# load("space_drpm1_run2.Rdata")
```


## NA/MSE analysis

```{r}
# y_with_na
# y
j = max(1,min(round(runif(1,1,N)),N))
t = round(runif(1,1,Tm))
# size(rout$fitted)
par(mfrow=c(2,1),mar=c(1,2,3,1))
plot(rout$fitted[t,j,],type="l",main=paste0("J trace plot of j=",j," at t=",t),
	 ylim=extrema(y[j,t],rout$fitted[t,j,],drpm1$fitted[t,j,]))
abline(h=y[j,t],col="#005500")
plot(drpm1$fitted[t,j,],type="l",main=paste0("C trace plot of j=",j," at t=",t),
	 ylim=extrema(y[j,t],rout$fitted[t,j,],drpm1$fitted[t,j,]))
abline(h=y[j,t],col="#005500")
```



```{r}
names(rout)

cat("Si           size = ",size(rout$Si),"\n")
cat("gamma        size = ",size(rout$gamma),"\n")
cat("sigma2h      size = ",size(rout$sigma2h),"\n")
cat("muh          size = ",size(rout$muh),"\n")
cat("alpha        size = ",size(rout$alpha),"\n")
cat("theta        size = ",size(rout$theta),"\n")
cat("tau2         size = ",size(rout$tau2),"\n")
cat("eta1         size = ",size(rout$eta1),"\n")
cat("phi0         size = ",size(rout$phi0),"\n")
cat("phi1         size = ",size(rout$phi1),"\n")
cat("lambda2      size = ",size(rout$lambda2),"\n")
cat("beta         size = ",size(rout$beta),"\n")
cat("fitted       size = ",size(rout$fitted),"\n")
cat("llike        size = ",size(rout$llike),"\n")

cat("lpml = ",rout$lpml,"\n")
cat("waic = ",rout$waic,"\n")
```

## Trace plots

### alpha
```{r}
for (time in 1:Tm){
		par(mfrow=c(1,2),mar=c(2,2,4,2))

plot(drpm1$alpha[,time],type="l",
	 main=bquote("Model DRPM C\nTrace plot of alpha at time "*.(time)
	 ), ylim=c(0,1),
	 xlab = "MCMC iterations",ylab="values")
	abline(h=mean(drpm1$alpha[,time]),col="#44aa44")
plot(rout$alpha[,time],type="l",
	 main=bquote("Model DRPM J\nTrace plot of alpha at time "*.(time)
	 ), ylim=c(0,1),
	 xlab = "MCMC iterations",ylab="values")
	abline(h=mean(rout$alpha[,time]),col="#44aa44")
}
```
### mu
```{r}
size(drpm1$mu)
size(rout$muh)
unitj = max(1,min(round(runif(1,0,N)),N))
for (time in 1:Tm){
		par(mfrow=c(2,2),mar=c(2,2,4,2))

	plot(drpm1$mu[time,unitj,],type="l",
		 ylim=c(min(drpm1$mu[time,unitj,],rout$muh[time,unitj,]),
		 	   max(drpm1$mu[time,unitj,],rout$muh[time,unitj,])),
		 main=bquote("Model DRPM C\nTrace plot of mu at time "*.(time) * " unit " * .(unitj)),
		 xlab = "MCMC iterations",ylab="values")
	plot(rout$muh[time,unitj,],type="l",
		 ylim=c(min(drpm1$mu[time,unitj,],rout$muh[time,unitj,]),
		 	   max(drpm1$mu[time,unitj,],rout$muh[time,unitj,])),
		 main=bquote("Model DRPM J\nTrace plot of mu at time "*.(time) * " unit " * .(unitj)),
		 xlab = "MCMC iterations",ylab="values")	
	
	hist(drpm1$mu[time,unitj,],
		 xlim=c(min(drpm1$mu[time,unitj,],rout$muh[time,unitj,]),
		 	   max(drpm1$mu[time,unitj,],rout$muh[time,unitj,])),
		 main=bquote("Model DRPM C\nTrace plot of mu at time "*.(time) * " unit " * .(unitj)))
	hist(rout$muh[time,unitj,],
		 xlim=c(min(drpm1$mu[time,unitj,],rout$muh[time,unitj,]),
		 	   max(drpm1$mu[time,unitj,],rout$muh[time,unitj,])),
		 main=bquote("Model DRPM J\nTrace plot of mu at time "*.(time) * " unit " * .(unitj)))
}
```

### sigma2
```{r}
size(drpm1$sig2)
size(rout$sigma2h)
# unitj = max(1,min(round(runif(1,0,N)),N))
for (time in 1:Tm){
		par(mfrow=c(2,2),mar=c(2,2,4,2))

	plot(drpm1$sig2[time,unitj,],type="l",
		 main=bquote("Model DRPM C\nTrace plot of sigma2 at time "*.(time) * " unit " * .(unitj)),
		 ylim=c(0,max(drpm1$sig2[time,unitj,], rout$sigma2h[time,unitj,])),
		 xlab = "MCMC iterations",ylab="values")
	plot(rout$sigma2h[time,unitj,],type="l",
		 main=bquote("Model DRPM J\nTrace plot of sigma2 at time "*.(time) * " unit " * .(unitj)),
		 ylim=c(0,max(drpm1$sig2[time,unitj,], rout$sigma2h[time,unitj,])),
		 xlab = "MCMC iterations",ylab="values")
	
	hist(drpm1$sig2[time,unitj,],
		 xlim=c(0,max(drpm1$sig2[time,unitj,], rout$sigma2h[time,unitj,])))
	hist(rout$sigma2h[time,unitj,],
		 xlim=c(0,max(drpm1$sig2[time,unitj,], rout$sigma2h[time,unitj,])))
}
```

### eta1
```{r}
dim(drpm1$eta1)
dim(rout$eta1)

cat("did we update eta1?", update_eta1)
for (unit in 1:N){
	par(mfrow=c(2,2),mar=c(2,2,4,2))
	plot(drpm1$eta1[,unit],type="l",
		 ylim=c(min(drpm1$eta1[,unit],rout$eta1[,unit]),
		 	    max(drpm1$eta1[,unit],rout$eta1[,unit])),
		 main=bquote("Model DRPM C\nTrace plot of eta1 at unit "*.(unit)),
		 xlab = "MCMC iterations",ylab="values")
	plot(rout$eta1[,unit],type="l",
		 ylim=c(min(drpm1$eta1[,unit],rout$eta1[,unit]),
		 	    max(drpm1$eta1[,unit],rout$eta1[,unit])),
		 main=bquote("Model DRPM J\nTrace plot of eta1 at unit "*.(unit)),
		 xlab = "MCMC iterations",ylab="values")
	
	hist(drpm1$eta1[,unit],
		 xlim=c(min(drpm1$eta1[,unit],rout$eta1[,unit]),
		 	    max(drpm1$eta1[,unit],rout$eta1[,unit])))
	hist(rout$eta1[,unit],
		 xlim=c(min(drpm1$eta1[,unit],rout$eta1[,unit]),
		 	    max(drpm1$eta1[,unit],rout$eta1[,unit])))
}
```


### theta
```{r}
for (time in 1:Tm){
	par(mfrow=c(2,2),mar=c(2,2,4,2))
	plot(drpm1$theta[,time],type="l",
		  ylim=c(min(drpm1$theta[,time],rout$theta[,time]),
		 	    max(drpm1$theta[,time],rout$theta[,time])),
		 main=bquote("Model DRPM C\nTrace plot of theta at time "*.(time)),
		 xlab = "MCMC iterations",ylab="values")
	plot(rout$theta[,time],type="l",
		  ylim=c(min(drpm1$theta[,time],rout$theta[,time]),
		 	    max(drpm1$theta[,time],rout$theta[,time])),
		 main=bquote("Model DRPM J\nTrace plot of theta at time "*.(time)),
		 xlab = "MCMC iterations",ylab="values")
	hist(drpm1$theta[,time],
		  xlim=c(min(drpm1$theta[,time],rout$theta[,time]),
		 	    max(drpm1$theta[,time],rout$theta[,time])))
	hist(rout$theta[,time],
		  xlim=c(min(drpm1$theta[,time],rout$theta[,time]),
		 	    max(drpm1$theta[,time],rout$theta[,time])))
}
```

### tau2
```{r}
dim(drpm1$tau2)
dim(rout$tau2)

for (time in 1:Tm){
	par(mfrow=c(2,2),mar=c(2,2,4,2))
	plot(drpm1$tau2[,time],type="l",
		 ylim=c(0,max(drpm1$tau2[,time],rout$tau2[,time])),
		 main=bquote("Model DRPM C\nTrace plot of tau2 at time "*.(time)),
		 xlab = "MCMC iterations",ylab="values")
	plot(rout$tau2[,time],type="l",
		 ylim=c(0,max(drpm1$tau2[,time],rout$tau2[,time])),
		 main=bquote("Model DRPM J\nTrace plot of tau2 at time "*.(time)),
		 xlab = "MCMC iterations",ylab="values")
	hist(drpm1$tau2[,time],
		 xlim=c(0,max(drpm1$tau2[,time],rout$tau2[,time])))
	hist(rout$tau2[,time],
		 xlim=c(0,max(drpm1$tau2[,time],rout$tau2[,time])))
}
```


### layer three
phi1, phi0, lambda2
```{r}
dim(drpm1$phi1)
dim(rout$phi1)

cat("did we update phi1?", update_phi1)
par(mfrow=c(2,2),mar=c(2,2,4,2))
plot(drpm1$phi1[,1],type="l",
	  ylim=c(min(drpm1$phi1[,1],rout$phi1[,1]),
		 	    max(drpm1$phi1[,1],rout$phi1[,1])),
	 main=bquote("Model DRPM C\nTrace plot of phi1"),
	 xlab = "MCMC iterations",ylab="values")
plot(rout$phi1[,1],type="l",
	  ylim=c(min(drpm1$phi1[,1],rout$phi1[,1]),
		 	    max(drpm1$phi1[,1],rout$phi1[,1])),
	 main=bquote("Model DRPM J\nTrace plot of phi1"),
	 xlab = "MCMC iterations",ylab="values")
hist(drpm1$phi1[,1],
	  xlim=c(min(drpm1$phi1[,1],rout$phi1[,1]),
		 	    max(drpm1$phi1[,1],rout$phi1[,1])))
hist(rout$phi1[,1],
	  xlim=c(min(drpm1$phi1[,1],rout$phi1[,1]),
		 	    max(drpm1$phi1[,1],rout$phi1[,1])))

dim(drpm1$phi0)
dim(rout$phi0)

par(mfrow=c(2,2),mar=c(2,2,4,2))
plot(drpm1$phi0[,1],type="l",
	 	  ylim=c(min(drpm1$phi0[,1],rout$phi0[,1]),
		 	    max(drpm1$phi0[,1],rout$phi0[,1])),
	 main=bquote("Model DRPM C\nTrace plot of phi0"),
	 xlab = "MCMC iterations",ylab="values")
plot(rout$phi0[,1],type="l",
	 	  ylim=c(min(drpm1$phi0[,1],rout$phi0[,1]),
		 	    max(drpm1$phi0[,1],rout$phi0[,1])),
	 main=bquote("Model DRPM J\nTrace plot of phi0"),
	 xlab = "MCMC iterations",ylab="values")
hist(drpm1$phi0[,1],
	 	  xlim=c(min(drpm1$phi0[,1],rout$phi0[,1]),
		 	    max(drpm1$phi0[,1],rout$phi0[,1])))
hist(rout$phi0[,1],
	 	  xlim=c(min(drpm1$phi0[,1],rout$phi0[,1]),
		 	    max(drpm1$phi0[,1],rout$phi0[,1])))


dim(drpm1$lam2)
dim(rout$lambda2)

par(mfrow=c(2,2),mar=c(2,2,4,2))
plot(drpm1$lam2[,1],type="l",
	 	  ylim=c(min(drpm1$lam2[,1],rout$lambda2[,1]),
		 	    max(drpm1$lam2[,1],rout$lambda2[,1])),
	 main=bquote("Model DRPM C\nTrace plot of lambda2"),
	 xlab = "MCMC iterations",ylab="values")
plot(rout$lambda2[,1],type="l",
	 	  ylim=c(min(drpm1$lam2[,1],rout$lambda2[,1]),
		 	    max(drpm1$lam2[,1],rout$lambda2[,1])),
	 main=bquote("Model DRPM J\nTrace plot of lambda2"),
	 xlab = "MCMC iterations",ylab="values")

hist(drpm1$lam2[,1],
	 	  xlim=c(min(drpm1$lam2[,1],rout$lambda2[,1]),
		 	    max(drpm1$lam2[,1],rout$lambda2[,1])))
hist(rout$lambda2[,1],
	 	  xlim=c(min(drpm1$lam2[,1],rout$lambda2[,1]),
		 	    max(drpm1$lam2[,1],rout$lambda2[,1])))
```




# functions
```{r}
N = size(y)[1]
Tm = size(y)[2]

generate_partition = function(model){
	partition = list()
	for (t in 1:Tm){
		Si_jt <- model$Si[t, , ]
		Si_jt <- t(Si_jt) 
		partition[[t]] <- salso(Si_jt, loss = "binder")
	}
	return(partition)
}

plot_partition_with_numbers = function(partition,title,cex=1.5,line=1.2){
	partition_matrix <- do.call(cbind, partition)
	plot(NULL, NULL, xlim = c(1, Tm), ylim = c(1, N)+c(-0.5,0.5),
	     xlab = "", ylab = "units",
	     xaxt = "n", yaxt = "n", main = title)
	axis(1, at = 1:Tm, labels = 1:Tm)
	for (t in 1:Tm) {
	  for (unit in 1:N) {
	    text(x = t, y = unit, labels = as.character(unit),
	         col = partition_matrix[unit, t], cex = cex)
	  }
	}
	title(xlab="time",line=line)
}

plot_partition_with_chars = function(partition,title,cex=1.5){
	pchs = letters[1:length(partition[[1]])]
	partition_matrix <- do.call(cbind, partition)
	plot(NULL, NULL, xlim = c(1, Tm), ylim = c(1, N)+c(-0.5,0.5),
	     xlab = "time", ylab = "units",
	     xaxt = "n", yaxt = "n", main = title)
	axis(1, at = 1:Tm, labels = 1:Tm)
	for (t in 1:Tm) {
	  for (unit in 1:N) {
	    text(x = t, y = unit, 
	    	 # labels = as.character(unit),
	    	 labels = pchs[unit],
	         col = partition_matrix[unit, t], cex = cex)
	  }
	}
}

plot_ARI = function(partition,title){
	LEN = Tm
	df_cluster = data.frame(clusters=c(),Time=c())
	for(time in 1:Tm){
		salso_out <- partition[[time]]
		df_temp = data.frame(
			clusters = salso_out
		)
		df_temp$Time = rep(time,dim(df_temp)[1])
		df_cluster = rbind(df_cluster,df_temp)
		# clusters log
		# clusters_now = df_temp$clusters
		# n_clusters = unique(clusters_now)
		# cat(crayon::red("Time",time,"- #clusters =",length(unique(clusters_now)),"\n"))
	}
	library(mclust)
	# build the ARI matrix
	ARImats <- matrix(NA, nrow=LEN, ncol=LEN)
	rho_ARI <- list()
	for(k in 1:LEN){
		rho_ARI[[k]] <- partition[[k]]
	}
	for(k in 1: LEN){
		for(kk in 1: LEN){
			ARImats[k,kk] <- adjustedRandIndex(rho_ARI[[k]], rho_ARI[[kk]])
		}
	}
	ncols_ari = 100
	# if (min(ARImats)<0){
		# cols_ARI = colora(ncols_ari,79,0)
		# brks = seq(min(-1,floor(min(ARImats))),1,length.out=ncols_ari+1)
	# } else {
		# cols_ARI = colora(ncols_ari,56,0)
		# cols_ARI = rev(cols_ARI) # must be ordered from cold to warm
		cols_ARI = rev(colora(ncols_ari,104,0)) # or 109
		# cols_ARI = colora(ncols_ari,102,0)
		# brks = seq(0,1,length.out=ncols_ari+1)
		brks = seq(min(-1,floor(min(ARImats))),1,length.out=ncols_ari+1)
	# }
	# or see ?designer.colors for colors
	library(fields)
	image.plot(ARImats,
			   main=paste0("Lagged ARI values - ",title),axes=FALSE,col=cols_ARI,
			   breaks=brks)
	mtext(text=c(paste("",1:LEN)), side=2, line=0.3,at=seq(0,1,length=LEN), las=1, cex=0.8)
	mtext(text=c(paste("",1:LEN)), side=1, line=0.3,at=seq(0,1,length=LEN), las=2, cex=0.8)
}

overlay_clusters = function(y_data,partition,title="",cexs=0.8){
par(mar=c(2,2,2,1))
for(i in 1:size(y_data)[1]){
   if(i==1){
     plot(1:size(y_data)[2],y_data[i,],col=cols[i],ylim=extrema(y_data),type='l',
     	 xlab='time',main=title)
 	  } 
	  else{
		  lines(1:size(y_data)[2],y_data[i,],col=cols[i])
	  }
}
partition_matrix <- do.call(cbind, partition)
for(i in 1:N){
	for (t in 1:Tm){
		points(t,y_data[i,t],col=partition_matrix[i, t],
			   pch=19,cex=cexs)
	}
}
}
```


## Partition plots
```{r}
# partition_plots = function(drpm1, rout){ 
# Initialize a list to store the partitions for each time instant
partitions_drpmc <- generate_partition(drpm1)
partitions_drpmj <- generate_partition(rout)

save_plots=F

# partition_matrix <- do.call(cbind, partitions)
# if (save_plots==T){
# 	pdf(file="partizioni_chars.pdf",width=12,height = 6)
# }
# par(mar=c(4,1,3,1),mfrow=c(1,2),oma=c(1,0.5,0.5,0.5))
# plot_partition_with_chars(partitions_drpmc, title="model C")
# plot_partition_with_chars(partitions_drpmj, title="model J")
# if (save_plots==T){ dev.off()}

if (save_plots==T){
	pdf(file="ari.pdf",width=10,height = 5)
}
par(mar=c(2,2,2,2),mfrow=c(1,2),oma=c(0.1,0.1,0.1,2))
plot_ARI(partitions_drpmc, title="model C")
plot_ARI(partitions_drpmj, title="model J")
if (save_plots==T){ dev.off()}


if (save_plots==T){
	# pdf(file="partizioni_nums.pdf",width=10,height = 4)
	pdf(file="partizioni_nums_higher.pdf",width=10,height = 5)
}
par(mar=c(3.2,1,2,1),mfrow=c(1,2),oma=c(0.1,0.1,0.1,0.1))
plot_partition_with_numbers(partitions_drpmc, title="model C",cex=1.5,line=2.1)
plot_partition_with_numbers(partitions_drpmj, title="model J",cex=1.5,line=2.1)
if (save_plots==T){ dev.off()}
```



# fitted values
```{r}
yredC=t(drpm1$fitted[,,size(drpm1$fitted)[3]])
yredJ=t(rout$fitted[,,size(rout$fitted)[3]])
yredORIG=y

save_plots=F

if (save_plots==TRUE) { 
	pdf(file="C_mean_prediction.pdf",height = 6,width=11)
	# pdf(file="C_median_prediction.pdf",height = 6,width=10)
	# pdf(file="C_last_iteration.pdf",height = 6,width=10)
}
##### take the median/mean/mode
summary_fitted = t(drpm1$fitted[,,size(rout$fitted)[3]])*0
for(j in 1:N){
	for(t in 1:Tm){
		values_j = c()
		for (it in 1:size(drpm1$fitted)[3]){
			values_j = c(values_j,drpm1$fitted[t,j,it])
		}
		summary_fitted[j,t] = mean(values_j)
		# summary_fitted[j,t] = median(values_j)
		# summary_fitted[j,t] = Mode(values_j) # function from include.R
	}
}
yred=summary_fitted
# take last sample (maybe not the best choice)
# yred=t(drpm1$fitted[,,size(drpm1$fitted)[3]])

par(mar=c(2,2,2,1))
cols = colora(size(yred)[1],56,0)
# cols = colora(N,"div",0)
cols = colora(N,"div",seed_div = "Paired",show = 0)
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],
     	 ylim=extrema(yredJ,yredC,yredORIG),type='l',xlab='',ylab="",
     	 # main="C fitted values - last iteration")
     	 main="C fitted values - iterations mean")
     	 # main="C fitted values - iterations median")
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}
if (save_plots==TRUE) { dev.off()}
#################################################################
if (save_plots==TRUE) { 
	pdf(file="J_mean_prediction.pdf",height = 6,width=11)
	# pdf(file="J_median_prediction.pdf",height = 6,width=10)
	# pdf(file="J_last_iteration.pdf",height = 6,width=10)
}
summary_fitted = t(rout$fitted[,,size(rout$fitted)[3]])*0
for(j in 1:N){
	for(t in 1:Tm){
		values_j = c()
		for (it in 1:size(rout$fitted)[3]){
			values_j = c(values_j,rout$fitted[t,j,it])
		}
		summary_fitted[j,t] = mean(values_j)
		# summary_fitted[j,t] = median(values_j)
		# summary_fitted[j,t] = Mode(values_j) # function from include.R
	}
}
yred=summary_fitted
# take last sample (maybe not the best choice)
# yred=t(rout$fitted[,,size(rout$fitted)[3]])

par(mar=c(2,2,2,1))
# cols = colora(size(yred)[1],56,0)
# cols = colora(N,"div",0)
cols = colora(N,"div",seed_div = "Paired",show = 0)
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],
     	 ylim=extrema(yredJ,yredC,yredORIG),type='l',xlab='',ylab="",
     	 # main="J fitted values - last iteration")
     	 main="J fitted values - iterations mean")
     	 # main="J fitted values - iterations median")
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}
if (save_plots==TRUE) { dev.off() }
#################################################################


yred=y
# cols = colora(N,"div",0)
cols = colora(N,"div",seed_div = "Paired",show = 0)
if (save_plots==TRUE) { 
	pdf(file="test_1_generated_data.pdf",height = 6,width=11)
}
par(mar=c(2,2,2,1))
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],ylim=extrema(yredJ,yredC,yredORIG),type='l',
     	 xlab='time',
     	 main='Generated values')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}
# pchs
# offsets = c(-0.1,-0.2,0,0,0,0.2,0,0,0.1,0.3)
# for(i in 1:N){
# 	text(12.1,yred[i,12]+offsets[i],label=pchs[i],col=cols[i],cex=0.8)
# }
# offsets = c(-0.2,-0.4,0.1,0.7,0.82,-0.8,0,0,0.2,0.1)
# for(i in 1:N){
# 	text(0.92,yred[i,1]+offsets[i],label=pchs[i],col=cols[i],cex=0.8)
# }
legend("bottom", legend = paste("unit", 1:size(yred)[1]), col = cols,
	   lty = 1,lwd=2,
	   cex=0.8, bty="n",
	   ncol=5)
if (save_plots==TRUE) { dev.off()}
```

```{r}
overlay_clusters(y,partitions_drpmc,title="C",cexs=0.8)
overlay_clusters(y,partitions_drpmj,title="J",cexs=0.8)
par(mar=c(4,1,3,1),mfrow=c(1,2),oma=c(0.5,0.1,0.1,0.1))
plot_partition_with_numbers(partitions_drpmc, title="model C",cex=1.4)
plot_partition_with_numbers(partitions_drpmj, title="model J",cex=1.4)
```

# clusters
```{r}
yred=y
cols = colora(N,"div",0)
# cols = colora(N,56,0)
cols = colora(N,"div",seed_div = "Paired",show = 0)
cexs = 1

save_plots=F

if (save_plots==TRUE) { 
	pdf(file="clusters_C.pdf",height = 6,width=11)
}
par(mar=c(2,2,2,1))
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],ylim=extrema(yredJ,yredC,yredORIG),type='l',
     	 xlab='time',
     	 main='Clusters according to model C-DRPM')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}
partition = partitions_drpmc
# partition = partitions_drpmj
partition_matrix <- do.call(cbind, partition)
for(i in 1:N){
	for (t in 1:Tm){
		points(t,yred[i,t],col=partition_matrix[i, t],pch=19,cex=cexs)
	}
}
if (save_plots==TRUE) { dev.off() }

# yred=y
# cols = colora(N,"div",0)
if (save_plots==TRUE) { 
	pdf(file="clusters_J.pdf",height = 6,width=11)
}
par(mar=c(2,2,2,1))
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],ylim=extrema(yredJ,yredC,yredORIG),type='l',
     	 xlab='time',
     	 main='Clusters according to model J-DRPM')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}

# partition = partitions_drpmc
partition = partitions_drpmj
partition_matrix <- do.call(cbind, partition)
for(i in 1:N){
	for (t in 1:Tm){
		points(t,yred[i,t],col=partition_matrix[i, t],
			   pch=19,cex=cexs)
	}
}
if (save_plots==TRUE) { dev.off() }
```


# compute mse
```{r}
yredORIGI=y
MSE_matrices = function(m1,m2){
	MSE = 0
	for (i in 1:size(m1)[1]){
		for (t in 1:size(m1)[2]){
			MSE = MSE + (m1[i,t]-m2[i,t])^2
		}
	}
	MSE = MSE/(size(m1)[1]*size(m1)[2])
	return(MSE)
}

##### take the median/mean/mode
summary_fitted_mean = t(drpm1$fitted[,,size(rout$fitted)[3]])*0
summary_fitted_median = t(drpm1$fitted[,,size(rout$fitted)[3]])*0
for(j in 1:N){
	for(t in 1:Tm){
		values_j = c()
		for (it in 1:size(drpm1$fitted)[3]){
			values_j = c(values_j,drpm1$fitted[t,j,it])
		}
		summary_fitted_mean[j,t] = mean(values_j)
		summary_fitted_median[j,t] = median(values_j)
		# summary_fitted[j,t] = Mode(values_j) # function from include.R
	}
}
cat("C MSE\n")
cat("mean ", MSE_matrices(summary_fitted_mean,yredORIGI),"\n")
cat("median ", MSE_matrices(summary_fitted_median,yredORIGI),"\n")
# take last sample (maybe not the best choice)
# yredC=t(drpm1$fitted[,,size(drpm1$fitted)[3]])
#################################################################
summary_fitted_mean = t(rout$fitted[,,size(rout$fitted)[3]])*0
summary_fitted_median = t(rout$fitted[,,size(rout$fitted)[3]])*0
for(j in 1:N){
	for(t in 1:Tm){
		values_j = c()
		for (it in 1:size(rout$fitted)[3]){
			values_j = c(values_j,rout$fitted[t,j,it])
		}
		summary_fitted_mean[j,t] = mean(values_j)
		summary_fitted_median[j,t] = median(values_j)
		# summary_fitted[j,t] = Mode(values_j) # function from include.R
	}
}
# take last sample (maybe not the best choice)
# yredJ=t(rout$fitted[,,size(rout$fitted)[3]])
#################################################################
cat("J MSE\n")
cat("mean ", MSE_matrices(summary_fitted_mean,yredORIGI),"\n")
cat("median ", MSE_matrices(summary_fitted_median,yredORIGI),"\n")
```


## ari pairwise
```{r,warning=F}
LEN = Tm
compare_ARI = function(Cmod1,Jmod2){
	ARIvec <- matrix(NA, nrow=1, ncol=LEN)
	for(k in 1: LEN){
		rhoC = generate_partition(Cmod1)
		rhoJ = generate_partition(Jmod2)
		ARIvec[k] <- adjustedRandIndex(rhoC[[k]][1:N], rhoJ[[k]][1:N])
	}	
	ncols_ari = 100
	cols_ARI = colora(ncols_ari,79,0)
	# cols_ARI = rev(cols_ARI)
	brks = seq(-1,1,length.out=ncols_ari+1)
	# pdf(paste0("./figures/DRPM/ARI/ari.pdf"), height=8, width=10)
	# svg(paste0("./figures/",base_folder,"/ARI/ari.svg"), height=8, width=10)
	# png(paste0("./figures/",base_folder,"/ARI/ari.png"),  width=700,height=600)
	library(fields)
	plot(1:Tm,ARIvec,type="l",main=paste0("ARI values"),ylim=c(-0.5,1))
	abline(h=0,col="gray80",lty=3)
	
	# image.plot(ARIvec,
	# 		   main=paste0("ARI values - ",mod1," vs ",mod2),axes=FALSE,col=cols_ARI,
	# 		   breaks=brks)
	# mtext(text=c(paste("",1:LEN)), side=2, line=0.3,at=seq(0,1,length=LEN), las=1, cex=0.8)

}

mods = c("DRPM","sPPM","Gaussian PPMx","Curve PPMx")
Cmod1 = drpm1
Jmod2 = rout
compare_ARI(Cmod1,Jmod2)
```

# ===========
# with NA
## setting NA
```{r}
# Number of elements to set as NA
y_NA = y

ndata = size(y)[1] * size(y)[2]

set.seed(113)
na_percentage = 0.1
na_percentage = 0.09620821
n_na <- round(ndata * na_percentage) # nstations * nday * na%
cat(n_na,"\n")

# Randomly sample positions to be set as NA
na_indices_j <- sample(size(y)[1], n_na,replace = T)
na_indices_t <- sample(size(y)[2], n_na,replace = T)

for (k in 1:n_na){
	cat("NAing index (",na_indices_j[k],",",na_indices_t[k],")\n")
	y_NA[na_indices_j[k], na_indices_t[k]] = NA
}

# Check the dataset
cat(sum(is.na(y_NA)))
# y_NA
```



## drpm J
```{r}
# module_JDRPM <- juliaImport(juliaCall("include", module))
out_NA = module_JDRPM$MCMC_fit(
	# Y=as.matrix(y),
	Y=as.matrix(y_NA),
	sp_coords = NA,
	M_dp = 1,                     
	initial_partition = NA,
	Xlk_covariates = NA,
	Xcl_covariates = NA,
	# initial_partition = c(1,2,1,2,2),
	
	starting_alpha = 0.5,         
	unit_specific_alpha = FALSE,       
	time_specific_alpha = TRUE,       
	update_alpha = TRUE,             
	
	include_eta1 = TRUE,                    
	include_phi1 = TRUE,
	update_eta1 = update_eta1,                    
	update_phi1 = update_phi1,
	
	sig2h_priors = c(a_sigma,b_sigma),
	eta1_priors = c(eta1_scale,sig_mh_eta1),
	# beta_priors = c(rep(1,p),2),
	beta_priors = NA,
	tau2_priors = c(a_tau,b_tau),
	phi0_priors = c(m0_phi0,s20_phi0),
	phi1_priors = sig_mh_phi1,
	lambda2_priors = c(a_lambda,b_lambda),
	alpha_priors = c(a_alpha,b_alpha),  
	
	# spatial_cohesion_idx = 4,
	# sp_params = list(c(1,2),1,2,matrix(c(1,2,2,4),nrow=2)),
	
	# covariate_similarity_idx = NA,  
	draws = as.integer(niter), burnin = as.integer(nburn),thin = as.integer(nthin),
	# draws = 100000, burnin = 60000,thin = 40,
	logging = FALSE,
	seed = 113.0
)
```

```{r}
# load(file = "nospace_full_CJ.Rdata")
# rout_FULL = rout
```


```{r}
rout_NA = juliaGet(out_NA)
names(rout_NA)  = c("Si",
				 "gamma",
				 "alpha", 
				 "sigma2h", 
				 "muh", 
				 "eta1",
				 "beta",
				 "theta", 
				 "tau2", 
				 "phi0", 
				 "phi1",
				 "lambda2",
				 "fitted",
				 "llike",
				 "lpml",
				 "waic")

# reshape some stuff to uniform it to drpm output
rout_NA$Si           = aperm(rout_NA$Si,       c(2, 1, 3))
rout_NA$gamma        = aperm(rout_NA$gamma,    c(2, 1, 3))
rout_NA$sigma2h      = aperm(rout_NA$sigma2h,  c(2, 1, 3))
rout_NA$muh          = aperm(rout_NA$muh,      c(2, 1, 3))
rout_NA$fitted       = aperm(rout_NA$fitted,   c(2, 1, 3))
rout_NA$llike        = aperm(rout_NA$llike,    c(2, 1, 3))
if (is.null(size(rout_NA$alpha))) {
	# do nothing
# } else if size(rout_NA$alpha) == 2 {
} else {
	rout_NA$alpha        = aperm(rout_NA$alpha,    c(2, 1))
}
rout_NA$theta        = aperm(rout_NA$theta,    c(2, 1))
rout_NA$tau2         = aperm(rout_NA$tau2,     c(2, 1))
rout_NA$eta1         = aperm(rout_NA$eta1,    c(2, 1))
rout_NA$phi0     = matrix(rout_NA$phi0,    ncol = 1)
rout_NA$phi1     = matrix(rout_NA$phi1,    ncol = 1)
rout_NA$lambda2  = matrix(rout_NA$lambda2, ncol = 1)
cat(crayon::red("\nLPML =",rout_NA$lpml, "\nWAIC =",rout_NA$waic))
```

```{r}
# save(rout_NA,file="no_space_NAJ.Rdata")
```

## Partition plots
```{r}
# partition_plots = function(drpm1, rout){ 
# Initialize a list to store the partitions for each time instant
partitions_drpmj_NA <- generate_partition(rout_NA)
partitions_drpmj_FL <- generate_partition(rout_FULL)

save_plots=F

# partition_matrix <- do.call(cbind, partitions)
# if (save_plots==T){
# 	pdf(file="partizioni_chars.pdf",width=12,height = 6)
# }
# par(mar=c(4,1,3,1),mfrow=c(1,2),oma=c(1,0.5,0.5,0.5))
# plot_partition_with_chars(partitions_drpmc, title="model C")
# plot_partition_with_chars(partitions_drpmj, title="model J")
# if (save_plots==T){ dev.off()}

if (save_plots==T){
	pdf(file="ari.pdf",width=10,height = 5)
}
par(mar=c(2,2,2,2),mfrow=c(1,2),oma=c(0.1,0.1,0.1,2))
plot_ARI(partitions_drpmj_NA, title="model J (NA data)")
plot_ARI(partitions_drpmj_FL, title="model J (full data)")
if (save_plots==T){ dev.off()}


if (save_plots==T){
	pdf(file="partizioni_nums.pdf",width=10,height = 4)
	# pdf(file="partizioni_nums_higher.pdf",width=10,height = 5)
}
par(mar=c(3.2,1,2,1),mfrow=c(1,2),oma=c(0.1,0.1,0.1,0.1))
plot_partition_with_numbers(partitions_drpmj_NA, title="model J (NA data)",cex=1.5,line=2.1)
plot_partition_with_numbers(partitions_drpmj_FL, title="model J (full data)",cex=1.5,line=2.1)
if (save_plots==T){ dev.off()}
```





# fitted values
```{r}
# save(rout_NA,file="nospace_NA_J.Rdata")
```


```{r}
yredORIG=y
save_plots=F

#################################################################
if (save_plots==TRUE) { 
	pdf(file="J_mean_prediction.pdf",height = 6,width=11)
	# pdf(file="J_median_prediction.pdf",height = 6,width=10)
	# pdf(file="J_last_iteration.pdf",height = 6,width=10)
}
summary_fitted_NA = t(rout_NA$fitted[,,size(rout_NA$fitted)[3]])*0
for(j in 1:N){
	for(t in 1:Tm){
		values_j = c()
		for (it in 1:size(rout_NA$fitted)[3]){
			values_j = c(values_j,rout_NA$fitted[t,j,it])
		}
		summary_fitted_NA[j,t] = mean(values_j)
		# summary_fitted_NA[j,t] = median(values_j)
		# summary_fitted_NA[j,t] = Mode(values_j) # function from include.R
	}
}
yred_NA=summary_fitted_NA
# take last sample (maybe not the best choice)
# yred=t(rout$fitted[,,size(rout$fitted)[3]])

#########################
summary_fitted_FULL= t(rout_FULL$fitted[,,size(rout_FULL$fitted)[3]])*0
for(j in 1:N){
	for(t in 1:Tm){
		values_j = c()
		for (it in 1:size(rout_FULL$fitted)[3]){
			values_j = c(values_j,rout_FULL$fitted[t,j,it])
		}
		summary_fitted_FULL[j,t] = mean(values_j)
		# summary_fitted_FULL[j,t] = median(values_j)
		# summary_fitted_FULL[j,t] = Mode(values_j) # function from include.R
	}
}
yred_FULL=summary_fitted_FULL
#########################

par(mar=c(2,2,2,1))
# cols = colora(size(yred)[1],56,0)
# cols = colora(N,"div",0)
cols = colora(N,"div",seed_div = "Paired",show = 0)
for(i in 1:size(yred_NA)[1]){
   if(i==1){
     plot(1:size(yred_NA)[2],yred_NA[i,],col=cols[i],
     	 ylim=extrema(yredORIG,yred_FULL,yred_NA),type='l',xlab='',ylab="",
     	 # main="J fitted values - last iteration")
     	 main="J fitted values (NA data) - iterations mean")
     	 # main="J fitted values - iterations median")
 	  } 
	  else{
		  lines(1:size(yred_NA)[2],yred_NA[i,],col=cols[i])
	  }
}
pch_diff = 18
for (k in 1:n_na){
		lines(c(na_indices_t[k],na_indices_t[k]),
		  # c(y[na_indices_j[k], na_indices_t[k]],yred[na_indices_j[k], na_indices_t[k]]),
		  c(yred_FULL[na_indices_j[k], na_indices_t[k]],
		    yred_NA[na_indices_j[k], na_indices_t[k]]),
		  col="#aaaaaa",lty=2)
	# points(na_indices_t[k],y[na_indices_j[k], na_indices_t[k]], col="#33aa33",pch=4)
	points(na_indices_t[k],yred_FULL[na_indices_j[k], na_indices_t[k]],
		   col="#009900",pch=pch_diff,cex=1.2)
	points(na_indices_t[k],yred_NA[na_indices_j[k], na_indices_t[k]],
		   col="#990000",pch=pch_diff,cex=1.2)

}
legend("bottom",legend=c("fitted with NA data","fitted with full data"),
	   col=c("#990000","#009900"),
	   pch=pch_diff,cex=1.2, bty="n")
if (save_plots==TRUE) { dev.off() }
#################################################################


yred=y
# cols = colora(N,"div",0)
cols = colora(N,"div",seed_div = "Paired",show = 0)
if (save_plots==TRUE) { 
	pdf(file="test_1_generated_data.pdf",height = 6,width=11)
}
par(mar=c(2,2,2,1))
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],ylim=extrema(yredORIG,yred_FULL,yred_NA)
     	 ,type='l',
     	 xlab='time',
     	 main='Generated values')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}
# pchs
# offsets = c(-0.1,-0.2,0,0,0,0.2,0,0,0.1,0.3)
# for(i in 1:N){
# 	text(12.1,yred[i,12]+offsets[i],label=pchs[i],col=cols[i],cex=0.8)
# }
# offsets = c(-0.2,-0.4,0.1,0.7,0.82,-0.8,0,0,0.2,0.1)
# for(i in 1:N){
# 	text(0.92,yred[i,1]+offsets[i],label=pchs[i],col=cols[i],cex=0.8)
# }
legend("bottom", legend = paste("unit", 1:size(yred)[1]), col = cols,
	   lty = 1,lwd=2,
	   cex=0.8, bty="n",
	   ncol=5)
if (save_plots==TRUE) { dev.off()}
```

# clusters
```{r}
yred=y
cols = colora(N,"div",0)
# cols = colora(N,56,0)
cols = colora(N,"div",seed_div = "Paired",show = 0)

save_plots=F

# yred=y
# cols = colora(N,"div",0)
if (save_plots==TRUE) { 
	pdf(file="clusters_J.pdf",height = 6,width=11)
}
par(mar=c(2,2,2,1))
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],ylim=extrema(yred_NA,yredORIG),type='l',
     	 xlab='time',
     	 main='Clusters according to model J-DRPM (NA data)')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}

# partition = partitions_drpmc
partition = partitions_drpmj_NA
partition_matrix <- do.call(cbind, partition)
for(i in 1:N){
	for (t in 1:Tm){
		pchh = 19
		if (is.na(y_NA[i,t])){
			pchh = 8
			cexs = 1.2
		}
		else {
			pchh = 19
			cexs = 1
		}
		points(t,yred[i,t],col=partition_matrix[i, t],
			   pch=pchh,cex=cexs)
	}
}
if (save_plots==TRUE) { dev.off() }
```

# compute mse
```{r}
yredORIGI=y
MSE_matrices = function(m1,m2){
	MSE = 0
	for (i in 1:size(m1)[1]){
		for (t in 1:size(m1)[2]){
			MSE = MSE + (m1[i,t]-m2[i,t])^2
		}
	}
	MSE = MSE/(size(m1)[1]*size(m1)[2])
	return(MSE)
}

#################################################################
summary_fitted_mean = t(rout_NA$fitted[,,size(rout_NA$fitted)[3]])*0
summary_fitted_median = t(rout_NA$fitted[,,size(rout_NA$fitted)[3]])*0
for(j in 1:N){
	for(t in 1:Tm){
		values_j = c()
		for (it in 1:size(rout_NA$fitted)[3]){
			values_j = c(values_j,rout_NA$fitted[t,j,it])
		}
		summary_fitted_mean[j,t] = mean(values_j)
		summary_fitted_median[j,t] = median(values_j)
		# summary_fitted[j,t] = Mode(values_j) # function from include.R
	}
}
# take last sample (maybe not the best choice)
# yredJ=t(rout$fitted[,,size(rout$fitted)[3]])
#################################################################
cat("J NA MSE\n")
cat("mean ", MSE_matrices(summary_fitted_mean,yredORIGI),"\n")
cat("median ", MSE_matrices(summary_fitted_median,yredORIGI),"\n")
```


















```{r}
# sort(unique(df_wsc$IDStations)) == sort(unique(df_daily_full_logtransf$IDStations))
# sort(unique(df_wsc$Latitude)) - sort(unique(df_daily_full_logtransf$Latitude))
# sort(unique(df_wsc$Longitude)) - sort(unique(df_daily_full_logtransf$Longitude))
```


# ===========
# 3. WITH SPACE
```{r}
load("../thesis data/df_wsc.Rdata")

# load("../thesis data/df_daily_full.Rdata")
# df_wsc = df_daily_full

# load("../thesis data/df_daily_full_logtransf.Rdata")
# df_wsc = df_daily_full_logtransf
# df_wsc$IDStations[which(df_wsc$IDStations=="STA-CH0011A")] = "STA.CH0011A"
# df_wsc$IDStations[which(df_wsc$IDStations=="STA-CH0033A")] = "STA.CH0033A"
# df_wsc$IDStations[which(df_wsc$IDStations=="STA-CH0043A")] = "STA.CH0043A"

unique(df_wsc$IDStations)
na_summary(df_wsc)
```



## real PM10 data
```{r}
sites_full = data.frame(
	longitude = unique(df_wsc$Longitude), 
	latitude = unique(df_wsc$Latitude))
stations = unique(df_wsc$IDStations)
yfull=data.frame()

target = "AQ_pm10"

for(st in stations){
	y_we_pm10=cbind(as.data.frame(st),t(df_wsc[which(df_wsc$IDStations==st),target]))
	yfull=rbind(yfull,y_we_pm10)
}
rownames(yfull) = NULL
colnames(yfull)<- c("id",paste0("w", 1:(size(yfull)[2]-1)))
# time_span = 1:14 # GOOD
# time_span = 1:4
time_span = 1:12

set.seed(110)
# quanti = 80; nsubjects = sample(1:105, quanti,replace = F)
# quanti = 30; nsubjects = sample(1:105, quanti,replace = F) #GOOD
# quanti = 60; nsubjects = sample(1:105, quanti,replace = F)
nsubjects = 1:105

y = yfull[nsubjects,1+time_span]
#############################################
# authors suggested to/did scale the spatial locations and also centered the observations

mn <- apply(y,2,mean)
sd <- apply(y,2,sd)

y <- t(t(y) - mn)
# y <- t(t(y) - mn)+1 # shifted 1

Tm = tps <- ncol(y) # time span
N = size(y)[1] # number of units
num_units = N

sites = sites_full[nsubjects,]
smn <- apply(sites,2,mean)
ssd <- apply(sites,2,sd)
s_std <- t((t(sites) - smn)/ssd)

# check
# mean(s_std[,1])
# mean(s_std[,2])
# var(s_std[,2])
# var(s_std[,1])
######################################

# yred=(y[,time_span]+0.5)*2
yred=y
par(mar=c(2,2,2,1))
# par(mar=c(4,4,2,2))
cols = colora(size(yred)[1],56,0)
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],
     	 # ylim=extrema(as.matrix(yred[,-c(1)])),
     	 ylim=extrema(as.matrix(yred)),
     	 type='l',xlab='weeks',ylab='pm10')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}
# for(i in 1:N){
# 	text(1,yred[i,1],i,cex=0.7)
# }

# -> we have
# y = yred
y
s_std
plot(s_std)
rownames(s_std) = NULL
```

```{r}
yred=y
# unit_summary <- rowMeans(yred)
unit_summary <- apply(yred, 1, median)
# unit_summary <- yred[,1]

cols = colora(105,111,0)
ranked_indices <- order(unit_summary, decreasing=TRUE)

par(mar=c(2,2,2,1))
col_idx = 1
for(i in ranked_indices){
   if(i==ranked_indices[1]){
     plot(1:size(yred)[2],yred[i,],col=cols[col_idx],
     	 # ylim=extrema(as.matrix(yred[,-c(1)])),
     	 ylim=extrema(as.matrix(yred)),
     	 type='l',xlab='weeks',ylab='pm10')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[col_idx])
	  }
	col_idx = col_idx+1
}

```



## othter interesting variables
```{r}
sites_full = data.frame(
	longitude = unique(df_wsc$Longitude), 
	latitude = unique(df_wsc$Latitude))
stations = unique(df_wsc$IDStations)


# targets = c("AQ_pm10","WE_tot_precipitation","LA_lvi","WE_blh_layer_max","Altitude","EM_nox_sum","EM_nh3_sum")
targets = colnames(df_wsc)[6:37]

for (target in targets){
	cat(target,"\n")
	yfull=data.frame()
if (typeof(unique(df_wsc[,target][[1]])) != "character"){
for(st in stations){
	y_we_pm10=cbind(as.data.frame(st),t(df_wsc[which(df_wsc$IDStations==st),target]))
	yfull=rbind(yfull,y_we_pm10)
}
rownames(yfull) = NULL
colnames(yfull)<- c("id",paste0("w", 1:(size(yfull)[2]-1)))
# time_span = 1:14 # GOOD
# time_span = 1:4
time_span = 1:12

set.seed(110)
# quanti = 80; nsubjects = sample(1:105, quanti,replace = F)
# quanti = 30; nsubjects = sample(1:105, quanti,replace = F) #GOOD
# quanti = 60; nsubjects = sample(1:105, quanti,replace = F)
nsubjects = 1:105

y = yfull[nsubjects,1+time_span]
#############################################
# authors suggested to/did scale the spatial locations and also centered the observations

mn <- apply(y,2,mean)
sd <- apply(y,2,sd)

y <- t(t(y) - mn)
# y <- t(t(y) - mn)+1 # shifted 1

Tm = tps <- ncol(y) # time span
N = size(y)[1] # number of units
num_units = N

sites = sites_full[nsubjects,]
smn <- apply(sites,2,mean)
ssd <- apply(sites,2,sd)
s_std <- t((t(sites) - smn)/ssd)

# check
# mean(s_std[,1])
# mean(s_std[,2])
# var(s_std[,2])
# var(s_std[,1])
######################################

# yred=(y[,time_span]+0.5)*2
yred=y

save_plot=T
folder = "./all_covariates_trend/"
if (save_plot==T) { pdf(file=paste0(folder,target,".pdf"),height = 6,width = 11)}
par(mar=c(2,2,2,1))
col_idx = 1
for(i in ranked_indices){
   if(i==ranked_indices[1]){
     plot(1:size(yred)[2],yred[i,],col=cols[col_idx],
     	 # ylim=extrema(as.matrix(yred[,-c(1)])),
     	 ylim=extrema(as.matrix(yred)),main=target,
     	 type='l',xlab='weeks',ylab='pm10')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[col_idx])
	  }
	col_idx = col_idx+1
}
if (save_plot==T) {dev.off()}
}
}
```


```{r}
cols = colora(105,56,show=F)
chosen_variable_name = "AQ_pm10"
trendYearStation_week <- function(file_name){
	data_from_to = df_wsc
	len_time = 1
	chosen_variable = (data_from_to[,chosen_variable_name])
	# Crea il grafico ggplot
	station_trend <- ggplot(data_from_to,aes(x = week, 
												 y = AQ_pm10,
												 group=IDStations, 
												 color = as.factor(IDStations))) +
		geom_line(show.legend = FALSE) +
		labs(x = "Stations", y = chosen_variable_name,
			 # title = bquote(PM[10] * " values - year 2018")) +
			 title = "PM10 values - year 2018") +
		ylim(range(na.omit(chosen_variable))) +
		scale_color_manual(values = cols) +
		theme_bw()+
		theme(panel.grid = element_blank()) +
		guides(color = guide_legend())+
		labs(x="",y="")

	len_time = (len_time%/%5)
	return(trend_animator(file_name,station_trend, data_from_to$week,len_time))
}
trendYearStation_week("None")
```


## Fits
```{r}
# as.integer(runif(1,0,1000))*1.0
seed = 888.0
# seed = 314.0
cat("seed",seed,"\n")
set.seed(seed)

# niter=10000; nburn=6000; nthin=4
# niter=50000; nburn=10000; nthin=40 # they did this in their tests
# niter=10000; nburn=0; nthin=1
# niter=20000; nburn=15000; nthin=5
# niter=50000; nburn=30000; nthin=20 # GOOD
# niter=80000; nburn=60000; nthin=20
niter=110000; nburn=90000; nthin=5
# niter=100000; nburn=60000; nthin=40
# niter=100; nburn=0; nthin=1
nout <- (niter-nburn)/nthin
cat(nout,"valid iterations\n")

niter = as.integer(niter)
nburn = as.integer(nburn)
nthin = as.integer(nthin)
```


```{r}
# params
m0_phi0 = 0
# s20_phi0 = 8
# A_ub_sigma = 7
s20_phi0 = 10
A_ub_sigma = 5
A_ub_tau = 5
A_ub_lambda = 5

# a_sigma  = 3; b_sigma  = 4
# a_tau    = 3; b_tau    = 4
# a_lambda = 3; b_lambda = 4

# a_sigma  = 2; b_sigma  = 2
# a_tau    = 2; b_tau    = 2
# a_lambda = 2; b_lambda = 2

a_sigma  = 0.01; b_sigma  = 0.01
a_lambda = 0.1; b_lambda = 0.1
# # a_tau    = 0.1; b_tau    = 0.1
a_tau    = 2; b_tau    = 2
# a_tau    = 1; b_tau    = 1.5


# a_sigma  = 5; b_sigma  = 8
# a_tau    = 5; b_tau    = 8
# a_lambda = 5; b_lambda = 8
eta1_scale = 0.9

# mh is the of gaussian standard deviations for metropolis updates
# So these are not variances!
sig_mh_sig2 = 0.2
sig_mh_tau2 = 0.2
sig_mh_lambda2 = 0.2
sig_mh_eta1 = 0.2
sig_mh_phi1 = 0.2

update_eta1 = TRUE
update_phi1 = F

a_alpha = 2; b_alpha = 2
time_specific_alpha = TRUE

# now space
spatial_cohesion = 3
mu0 = 0 
k0 = 1
v0 = 5
L0 = 1
```


```{r}
# load("../thesis data/df_daily_full.Rdata")
times = unique(df_daily_full$Time)
as.numeric(df_daily_full[df_daily_full$Time==times[1],"WE_precipitation_t"])
```


```{r}
times = unique(df_wsc$Time)
# as.numeric(df_wsc[df_wsc$Time==times[1],"Altitude"][[1]])
as.numeric(df_wsc[df_wsc$Time==times[1],"WE_precipitation_t"][[1]])
```


## drpm C
```{r}
set.seed(221)
tempo_inizio <- Sys.time()
drpm1 <- drpm_fit(
		y=y, 
		s_coords = s_std,
        M=1,
        initial_partition = NULL,
		
        starting_alpha = 0.5,
        unit_specific_alpha = FALSE,
        time_specific_alpha = time_specific_alpha,
        alpha_0=FALSE,
		
        eta1_0=!(update_eta1),
        # phi1_0=!(update_phi1),
        phi1_0=FALSE,
        # modelPriors=c(0,100^2,1,1,1,1), # original default one
        modelPriors=c(m0_phi0,s20_phi0,A_ub_sigma,A_ub_tau,A_ub_lambda,eta1_scale),

        alphaPriors=rbind(c(a_alpha,b_alpha)), # if time_specific_alpha == TRUE
        
        simpleModel = 0,
        theta_tau2 = c(0, 2), # only used if simpleModel=1

		SpatialCohesion=spatial_cohesion, # auxiliary similarity
		# SpatialCohesion=4, # double dipper similarity
		cParms=c(mu0, k0, v0, L0),
		
		mh=c(sig_mh_sig2,sig_mh_tau2,sig_mh_lambda2,sig_mh_eta1,sig_mh_phi1),
		verbose=TRUE,
		# draws=4000,burn=2000,thin=2)
		draws=niter,burn=nburn,thin=nthin)

tempo_fine <- Sys.time()
differenza_tempo <- tempo_fine - tempo_inizio
cat(crayon::cyan("Fit took:\n"))
print(round(differenza_tempo,digits = 4))

cat(crayon::red("\nLPML =",drpm1$lpml, "\nWAIC =",drpm1$waic))
```


```{r}
# load(file="space_80k_drpm1.Rdata")
save(drpm1,file="space_drpm1_run6.Rdata")
```


```{r}
names(drpm1)

cat("\nSi     size = ",size(drpm1$Si),"\n")
cat("gamma  size = ",size(drpm1$gamma),"\n")
cat("mu     size = ",size(drpm1$mu),"\n")
cat("sig2   size = ",size(drpm1$sig2),"\n")
cat("alpha  size = ",size(drpm1$alpha),"\n")
cat("theta  size = ",size(drpm1$theta),"\n")
cat("tau2   size = ",size(drpm1$tau2),"\n")
cat("eta1   size = ",size(drpm1$eta1),"\n")
cat("phi0   size = ",size(drpm1$phi0),"\n")
cat("phi1   size = ",size(drpm1$phi1),"\n")
cat("lam2   size = ",size(drpm1$lam2),"\n")
cat("llike  size = ",size(drpm1$llike),"\n")
cat("fitted size = ",size(drpm1$fitted),"\n")
```

```{r}
# save(drpm1,file="space_C.Rdata")
```

## clustering covariates
```{r}
n = dim(y)[1]
# Tm

# colnames(df_wsc)
covariate_scelte = c(
	"Altitude"
	# ,"WE_temp_2m"
	# ,"WE_wind_speed_10m_mean"
	# ,"WE_wind_speed_10m_max"
	# ,"WE_mode_wind_direction_10m"
	# "WE_tot_precipitation"
	# ,"WE_precipitation_t"
	# ,"WE_surface_pressure"
	# ,"WE_solar_radiation"
	# ,"WE_rh_min"
	# ,"WE_rh_mean"
	# ,"WE_rh_max"
	# ,"WE_wind_speed_100m_mean"
	# ,"WE_wind_speed_100m_max"
	# ,"WE_mode_wind_direction_100m"
	# ,"WE_blh_layer_max"
	# ,"WE_blh_layer_min"
	# ,"EM_nh3_livestock_mm"
	# ,"EM_nh3_agr_soils"
	# ,"EM_nh3_agr_waste_burn"
	# ,"EM_nh3_sum"
	# ,"EM_nox_traffic"
	# ,"EM_nox_sum"
	# ,"EM_so2_sum"
	# ,"LI_pigs"
	# ,"LI_bovine"
	# ,"LI_pigs_v2"
	# ,"LI_bovine_v2"
	# ,"LA_hvi"
	# ,"LA_lvi"
	# ,"LA_land_use"
	# ,"day"
	# ,"week"
	)

p = lenght(covariate_scelte)
X_cl = array(data = 0, dim = c(n, p, Tm))
dim(X_cl)
cat("N * p * T = ",n,"*",p,"*",Tm,"\n")

for(i in 1:n){
	st = stations[i]
	for(t in 1:Tm){
		df_st = df_wsc[which(df_wsc$IDStations == st),]
		for (pp in 1:p){
			X_cl[i,pp,t] = as.numeric(df_st[t,covariate_scelte[pp]])
		}
	}
}
colnames(X_cl) = covariate_scelte
head(X_cl)
```



## likelihood covariates
```{r}
n = dim(y)[1]
# Tm

colnames(df_wsc)
# penso vadano scelte quelle correlate alla target variable
# perchÃ© qui vogliamo solo migliorare il fit, non individuare/separare i cluster
covariate_scelte = c(
	"Altitude"
	,"WE_temp_2m"
	# ,"WE_wind_speed_10m_mean"
	# ,"WE_wind_speed_10m_max"
	# ,"WE_mode_wind_direction_10m"
	,"WE_tot_precipitation"
	# ,"WE_precipitation_t"
	# ,"WE_surface_pressure"
	# ,"WE_solar_radiation"
	# ,"WE_rh_min"
	# ,"WE_rh_mean"
	# ,"WE_rh_max"
	# ,"WE_wind_speed_100m_mean"
	# ,"WE_wind_speed_100m_max"
	# ,"WE_mode_wind_direction_100m"
	# ,"WE_blh_layer_max"
	,"WE_blh_layer_min"
	# ,"EM_nh3_livestock_mm"
	# ,"EM_nh3_agr_soils"
	# ,"EM_nh3_agr_waste_burn"
	# ,"EM_nh3_sum"
	,"EM_nox_traffic"
	# ,"EM_nox_sum"
	# ,"EM_so2_sum"
	# ,"LI_pigs"
	# ,"LI_bovine"
	# ,"LI_pigs_v2"
	# ,"LI_bovine_v2"
	# ,"LA_hvi"
	# ,"LA_lvi"
	# ,"LA_land_use"
	# ,"day"
	# ,"week"
	)

p = lenght(covariate_scelte)
X_lk = array(data = 0, dim = c(n, p, Tm))
dim(X_lk)
cat("N * p * T = ",n,"*",p,"*",Tm,"\n")

for(i in 1:n){
	st = stations[i]
	for(t in 1:Tm){
		df_st = df_wsc[which(df_wsc$IDStations == st),]
		for (pp in 1:p){
			X_lk[i,pp,t] = as.numeric(df_st[t,covariate_scelte[pp]])
		}
	}
}
colnames(X_lk) = covariate_scelte
head(X_lk)
```


```{r}
module_JDRPM <- juliaImport(juliaCall("include", module))
module_JDRPM$trigger_compilation()
```


## drpm J
```{r}
a_sigma  = 0.01; b_sigma = 0.01
# a_tau    = 2.1; b_tau   = 0.9
# a_tau    = 1.7; b_tau   = 0.4
a_tau    = 1.9; b_tau   = 0.4
# a_lambda = 0.1; b_lambda = 0.1
a_lambda = 1.9; b_lambda = 0.4

# module_JDRPM <- juliaImport(juliaCall("include", module))
out = module_JDRPM$MCMC_fit(
	Y=as.matrix(y),              
	sp_coords = s_std,
	M_dp = 1,                     
	initial_partition = NA,
	Xlk_covariates = NA,
	Xcl_covariates = NA,
	
	starting_alpha = 0.5,         
	unit_specific_alpha = FALSE,       
	time_specific_alpha = TRUE,       
	update_alpha = TRUE,             
	
	include_eta1 = TRUE,                    
	include_phi1 = T,
	update_eta1 = update_eta1,                    
	update_phi1 = T,
	
	sig2h_priors = c(a_sigma,b_sigma),
	eta1_priors = c(eta1_scale,sig_mh_eta1),
	# beta_priors = c(rep(1,p),2),
	beta_priors = NA,
	tau2_priors = c(a_tau,b_tau),
	phi0_priors = c(m0_phi0,s20_phi0),
	phi1_priors = sig_mh_phi1,
	lambda2_priors = c(a_lambda,b_lambda),
	alpha_priors = c(a_alpha,b_alpha),  
	
	######## space
	# spatial_cohesion_idx = spatial_cohesion,
	# sp_params = list(c(mu0,mu0),k0,v0,matrix(c(L0,0.0,0.0,L0),nrow=2)),
	spatial_cohesion_idx = 1,
	sp_params = list(0.60),
	
	######## likelihood covariates
	# Xlk_covariates = X_lk, beta_priors = c(rep(0,p),1),
	# Xlk_covariates = NA, beta_priors = NA,
	
	######## clustering covariates
	# covariate_similarity_idx = 4,
	# cv_params = list(0,1,2,2),
	# Xcl_covariates = X_cl,
	
	# spatial_cohesion_idx = 1,
	# sp_params = list(0.1),
	
	# covariate_similarity_idx = NA,
	draws = niter,burnin = nburn, thin = nthin,
	# draws = 1000,burnin = 20, thin = 4,
	logging = F,
	seed = 113.0,
	simple_return = FALSE,
	verbose = T,
	perform_diagnostics = TRUE
)

```

## rout
```{r}
rout = juliaGet(out)
names(rout)  = c("Si",
				 "gamma",
				 "alpha",
				 "sigma2h",
				 "muh",
				 "eta1",
				 "beta",
				 "theta",
				 "tau2",
				 "phi0",
				 "phi1",
				 "lambda2",
				 "fitted",
				 "llike",
				 "lpml",
				 "waic")

# reshape some stuff to uniform it to drpm output
rout$Si           = aperm(rout$Si,       c(2, 1, 3))
rout$gamma        = aperm(rout$gamma,    c(2, 1, 3))
rout$sigma2h      = aperm(rout$sigma2h,  c(2, 1, 3))
rout$muh          = aperm(rout$muh,      c(2, 1, 3))
rout$fitted       = aperm(rout$fitted,   c(2, 1, 3))
rout$llike        = aperm(rout$llike,    c(2, 1, 3))
rout$alpha        = aperm(rout$alpha,    c(2, 1))
rout$theta        = aperm(rout$theta,    c(2, 1))
rout$tau2         = aperm(rout$tau2,     c(2, 1))
rout$eta1         = aperm(rout$eta1,    c(2, 1))
rout$phi0     = matrix(rout$phi0,    ncol = 1)
rout$phi1     = matrix(rout$phi1,    ncol = 1)
rout$lambda2  = matrix(rout$lambda2, ncol = 1)
cat(crayon::red("\nLPML =",rout$lpml, "\nWAIC =",rout$waic))
```


```{r}
# getwd()
# load(file="space_drpm1_run2.Rdata")
save(rout,file="space_rout_full_run6_dfweekly_spcohes1.Rdata")
# save(rout,file="space_rout_full_run5_dfdaily.Rdata")
```


```{r}
names(rout)

cat("Si           size = ",size(rout$Si),"\n")
cat("gamma        size = ",size(rout$gamma),"\n")
cat("sigma2h      size = ",size(rout$sigma2h),"\n")
cat("muh          size = ",size(rout$muh),"\n")
cat("alpha        size = ",size(rout$alpha),"\n")
cat("theta        size = ",size(rout$theta),"\n")
cat("tau2         size = ",size(rout$tau2),"\n")
cat("eta1         size = ",size(rout$eta1),"\n")
cat("phi0         size = ",size(rout$phi0),"\n")
cat("phi1         size = ",size(rout$phi1),"\n")
cat("lambda2      size = ",size(rout$lambda2),"\n")
cat("beta         size = ",size(rout$beta),"\n")
cat("fitted       size = ",size(rout$fitted),"\n")
cat("llike        size = ",size(rout$llike),"\n")

cat("lpml = ",rout$lpml,"\n")
cat("waic = ",rout$waic,"\n")
```

# LOAD models
```{r}
load("./df wsc fits/space_drpm1_run6.Rdata")
# load("./df wsc fits/space_rout_full_run4_dfweekly.Rdata")

# load("./df daily fits/space_drpm1_run2.Rdata")
# load("./df daily fits/space_rout_full_run1_dfdaily.Rdata")
```


## MSE analysis
```{r}
# y_with_na
# y
j = round(runif(1,1,N))
t = round(runif(1,1,Tm))
j = 101
# j =96
# t = 4
size(rout$fitted)
par(mfrow=c(2,1),mar=c(1,2,3,1))
plot(rout$fitted[t,j,],type="l",main=paste0("J trace plot of j=",j," at t=",t),
	 ylim=extrema(y[j,t],rout$fitted[t,j,],drpm1$fitted[t,j,]))
abline(h=y[j,t],col="#005500")
plot(drpm1$fitted[t,j,],type="l",main=paste0("C trace plot of j=",j," at t=",t),
	 ylim=extrema(y[j,t],rout$fitted[t,j,],drpm1$fitted[t,j,]))
abline(h=y[j,t],col="#005500")
```

## Trace plots
```{r}
# load("space_drpm1_new.Rdata")
# load("space_rout_new_test1.Rdata")
```

### beta
```{r}
rout = rout_NA
for (covariata_idx in 1:length(covariate_scelte)){
	cols = colora(size(rout$beta)[3],44,0)
	# verde scuro: iterazioni iniziali
	# giallo: iterazioni finali
	par(mar=c(3,3,3,1))
	for (iter in 1:size(rout$beta)[3]){
		if(iter==1) {
			plot(rout$beta[,covariata_idx,iter],
				 ylim=extrema(rout$beta[,covariata_idx,]),
				 # main=covariate_scelte[covariata_idx],
				 main=bquote(beta[t] * " regression vector for Altitude covariate"),
				 col = cols[iter],type="l")
		} else {
			lines(rout$beta[,covariata_idx,iter],col = cols[iter])
		}
	}
	legend("topleft",legend = c("initial iterates","final iterates"),
		   col = c(cols[1],cols[size(rout$beta)[3]]),lty=c(1,1),
		   lwd=3,cex=0.6,bty="n"
		   )
	# boxplot(rout$beta[,covariata_idx,],
		# main=covariate_scelte[covariata_idx])
}
```

### alpha
```{r}
for (time in 1:Tm){
		par(mfrow=c(1,2),mar=c(2,2,4,2))

plot(drpm1$alpha[,time],type="l",
	 main=bquote("Model DRPM C\nTrace plot of alpha at time "*.(time)
	 ), ylim=c(0,1),
	 xlab = "MCMC iterations",ylab="values")
	abline(h=mean(drpm1$alpha[,time]),col="#44aa44")
plot(rout$alpha[,time],type="l",
	 main=bquote("Model DRPM J\nTrace plot of alpha at time "*.(time)
	 ), ylim=c(0,1),
	 xlab = "MCMC iterations",ylab="values")
	abline(h=mean(rout$alpha[,time]),col="#44aa44")
}
```
### mu
```{r}
size(drpm1$mu)
size(rout$muh)
unitj = round(runif(1,1,N))
# unitj = 17
for (time in 1:Tm){
		par(mfrow=c(2,2),mar=c(2,2,4,2))

	plot(drpm1$mu[time,unitj,],type="l",
		 ylim=c(min(drpm1$mu[time,unitj,],rout$muh[time,unitj,]),
		 	   max(drpm1$mu[time,unitj,],rout$muh[time,unitj,])),
		 main=bquote("Model DRPM C\nTrace plot of mu at time "*.(time) * " unit " * .(unitj)),
		 xlab = "MCMC iterations",ylab="values")
	plot(rout$muh[time,unitj,],type="l",
		 ylim=c(min(drpm1$mu[time,unitj,],rout$muh[time,unitj,]),
		 	   max(drpm1$mu[time,unitj,],rout$muh[time,unitj,])),
		 main=bquote("Model DRPM J\nTrace plot of mu at time "*.(time) * " unit " * .(unitj)),
		 xlab = "MCMC iterations",ylab="values")	
	
	hist(drpm1$mu[time,unitj,],
		 xlim=c(min(drpm1$mu[time,unitj,],rout$muh[time,unitj,]),
		 	   max(drpm1$mu[time,unitj,],rout$muh[time,unitj,])),
		 main=bquote("Model DRPM C\nTrace plot of mu at time "*.(time) * " unit " * .(unitj)))
	hist(rout$muh[time,unitj,],
		 xlim=c(min(drpm1$mu[time,unitj,],rout$muh[time,unitj,]),
		 	   max(drpm1$mu[time,unitj,],rout$muh[time,unitj,])),
		 main=bquote("Model DRPM J\nTrace plot of mu at time "*.(time) * " unit " * .(unitj)))
}
```

### sigma2
```{r}
size(drpm1$sig2)
size(rout$sigma2h)
# unitj = round(runif(1,1,N))
for (time in 1:Tm){
		par(mfrow=c(2,2),mar=c(2,2,4,2))

	plot(drpm1$sig2[time,unitj,],type="l",
		 main=bquote("Model DRPM C\nTrace plot of sigma2 at time "*.(time) * " unit " * .(unitj)),
		 ylim=c(0,max(drpm1$sig2[time,unitj,], rout$sigma2h[time,unitj,])),
		 xlab = "MCMC iterations",ylab="values")
	plot(rout$sigma2h[time,unitj,],type="l",
		 main=bquote("Model DRPM J\nTrace plot of sigma2 at time "*.(time) * " unit " * .(unitj)),
		 ylim=c(0,max(drpm1$sig2[time,unitj,], rout$sigma2h[time,unitj,])),
		 xlab = "MCMC iterations",ylab="values")
	
	hist(drpm1$sig2[time,unitj,],
		 xlim=c(0,max(drpm1$sig2[time,unitj,], rout$sigma2h[time,unitj,])))
	hist(rout$sigma2h[time,unitj,],
		 xlim=c(0,max(drpm1$sig2[time,unitj,], rout$sigma2h[time,unitj,])))
}
```

### eta1
```{r}
dim(drpm1$eta1)
dim(rout$eta1)

cat("did we update eta1?", update_eta1)
for (unit in 1:min(N,10)){
	par(mfrow=c(2,2),mar=c(2,2,4,2))
	plot(drpm1$eta1[,unit],type="l",
		 ylim=c(min(drpm1$eta1[,unit],rout$eta1[,unit]),
		 	    max(drpm1$eta1[,unit],rout$eta1[,unit])),
		 main=bquote("Model DRPM C\nTrace plot of eta1 at unit "*.(unit)),
		 xlab = "MCMC iterations",ylab="values")
	plot(rout$eta1[,unit],type="l",
		 ylim=c(min(drpm1$eta1[,unit],rout$eta1[,unit]),
		 	    max(drpm1$eta1[,unit],rout$eta1[,unit])),
		 main=bquote("Model DRPM J\nTrace plot of eta1 at unit "*.(unit)),
		 xlab = "MCMC iterations",ylab="values")
	
	hist(drpm1$eta1[,unit],
		 xlim=c(min(drpm1$eta1[,unit],rout$eta1[,unit]),
		 	    max(drpm1$eta1[,unit],rout$eta1[,unit])))
	hist(rout$eta1[,unit],
		 xlim=c(min(drpm1$eta1[,unit],rout$eta1[,unit]),
		 	    max(drpm1$eta1[,unit],rout$eta1[,unit])))
}
```


### theta
```{r}
for (time in 1:Tm){
	par(mfrow=c(2,2),mar=c(2,2,4,2))
	plot(drpm1$theta[,time],type="l",
		  ylim=c(min(drpm1$theta[,time],rout$theta[,time]),
		 	    max(drpm1$theta[,time],rout$theta[,time])),
		 main=bquote("Model DRPM C\nTrace plot of theta at time "*.(time)),
		 xlab = "MCMC iterations",ylab="values")
	plot(rout$theta[,time],type="l",
		  ylim=c(min(drpm1$theta[,time],rout$theta[,time]),
		 	    max(drpm1$theta[,time],rout$theta[,time])),
		 main=bquote("Model DRPM J\nTrace plot of theta at time "*.(time)),
		 xlab = "MCMC iterations",ylab="values")
	hist(drpm1$theta[,time],
		  xlim=c(min(drpm1$theta[,time],rout$theta[,time]),
		 	    max(drpm1$theta[,time],rout$theta[,time])))
	hist(rout$theta[,time],
		  xlim=c(min(drpm1$theta[,time],rout$theta[,time]),
		 	    max(drpm1$theta[,time],rout$theta[,time])))
}
```

### tau2
```{r}
dim(drpm1$tau2)
dim(rout$tau2)

for (time in 1:Tm){
	par(mfrow=c(2,2),mar=c(2,2,4,2))
	plot(drpm1$tau2[,time],type="l",
		 ylim=c(0,max(drpm1$tau2[,time],rout$tau2[,time])),
		 main=bquote("Model DRPM C\nTrace plot of tau2 at time "*.(time)),
		 xlab = "MCMC iterations",ylab="values")
	plot(rout$tau2[,time],type="l",
		 ylim=c(0,max(drpm1$tau2[,time],rout$tau2[,time])),
		 main=bquote("Model DRPM J\nTrace plot of tau2 at time "*.(time)),
		 xlab = "MCMC iterations",ylab="values")
	hist(drpm1$tau2[,time],
		 xlim=c(0,max(drpm1$tau2[,time],rout$tau2[,time])))
	hist(rout$tau2[,time],
		 xlim=c(0,max(drpm1$tau2[,time],rout$tau2[,time])))
}
```


### layer three
phi1, phi0, lambda2
```{r}
dim(drpm1$phi1)
dim(rout$phi1)

cat("did we update phi1?", update_phi1)
par(mfrow=c(2,2),mar=c(2,2,4,2))
if (!all(is.na(rout$phi1))){
plot(drpm1$phi1[,1],type="l",
	  ylim=c(min(drpm1$phi1[,1],rout$phi1[,1]),
		 	    max(drpm1$phi1[,1],rout$phi1[,1])),
	 main=bquote("Model DRPM C\nTrace plot of phi1"),
	 xlab = "MCMC iterations",ylab="values")
plot(rout$phi1[,1],type="l",
	  ylim=c(min(drpm1$phi1[,1],rout$phi1[,1]),
		 	    max(drpm1$phi1[,1],rout$phi1[,1])),
	 main=bquote("Model DRPM J\nTrace plot of phi1"),
	 xlab = "MCMC iterations",ylab="values")
hist(drpm1$phi1[,1],
	  xlim=c(min(drpm1$phi1[,1],rout$phi1[,1]),
		 	    max(drpm1$phi1[,1],rout$phi1[,1])))
hist(rout$phi1[,1],
	  xlim=c(min(drpm1$phi1[,1],rout$phi1[,1]),
		 	    max(drpm1$phi1[,1],rout$phi1[,1])))
}

dim(drpm1$phi0)
dim(rout$phi0)

par(mfrow=c(2,2),mar=c(2,2,4,2))
plot(drpm1$phi0[,1],type="l",
	 	  ylim=c(min(drpm1$phi0[,1],rout$phi0[,1]),
		 	    max(drpm1$phi0[,1],rout$phi0[,1])),
	 main=bquote("Model DRPM C\nTrace plot of phi0"),
	 xlab = "MCMC iterations",ylab="values")
plot(rout$phi0[,1],type="l",
	 	  ylim=c(min(drpm1$phi0[,1],rout$phi0[,1]),
		 	    max(drpm1$phi0[,1],rout$phi0[,1])),
	 main=bquote("Model DRPM J\nTrace plot of phi0"),
	 xlab = "MCMC iterations",ylab="values")
hist(drpm1$phi0[,1],
	 	  xlim=c(min(drpm1$phi0[,1],rout$phi0[,1]),
		 	    max(drpm1$phi0[,1],rout$phi0[,1])))
hist(rout$phi0[,1],
	 	  xlim=c(min(drpm1$phi0[,1],rout$phi0[,1]),
		 	    max(drpm1$phi0[,1],rout$phi0[,1])))


dim(drpm1$lam2)
dim(rout$lambda2)

par(mfrow=c(2,2),mar=c(2,2,4,2))
plot(drpm1$lam2[,1],type="l",
	 	  ylim=c(min(drpm1$lam2[,1],rout$lambda2[,1]),
		 	    max(drpm1$lam2[,1],rout$lambda2[,1])),
	 main=bquote("Model DRPM C\nTrace plot of lambda2"),
	 xlab = "MCMC iterations",ylab="values")
plot(rout$lambda2[,1],type="l",
	 	  ylim=c(min(drpm1$lam2[,1],rout$lambda2[,1]),
		 	    max(drpm1$lam2[,1],rout$lambda2[,1])),
	 main=bquote("Model DRPM J\nTrace plot of lambda2"),
	 xlab = "MCMC iterations",ylab="values")

hist(drpm1$lam2[,1],
	 	  xlim=c(min(drpm1$lam2[,1],rout$lambda2[,1]),
		 	    max(drpm1$lam2[,1],rout$lambda2[,1])))
hist(rout$lambda2[,1],
	 	  xlim=c(min(drpm1$lam2[,1],rout$lambda2[,1]),
		 	    max(drpm1$lam2[,1],rout$lambda2[,1])))
```


#-------------
# functions
```{r}
N = size(y)[1]
Tm = size(y)[2]

generate_partition = function(model,loss="binder",maxcl=0){
	partition = list()
	for (t in 1:Tm){
		Si_jt <- model$Si[t, , ]
		Si_jt <- t(Si_jt) 
		partition[[t]] <- salso(Si_jt, loss = loss,maxNClusters = maxcl)
	}
	return(partition)
}

plot_partition_with_numbers = function(partition,title,cex=1.5,line=1.2){
	partition_matrix <- do.call(cbind, partition)
	plot(NULL, NULL, xlim = c(1, Tm), ylim = c(1, N)+c(-0.5,0.5),
	     xlab = "", ylab = "units",
	     xaxt = "n", yaxt = "n", main = title)
	axis(1, at = 1:Tm, labels = 1:Tm)
	for (t in 1:Tm) {
	  for (unit in 1:N) {
	    text(x = t, y = unit, labels = as.character(unit),
	         col = partition_matrix[unit, t], cex = cex)
	  }
	}
	title(xlab="time",line=line)
}

plot_partition_with_chars = function(partition,title,cex=1.5){
	pchs = letters[1:length(partition[[1]])]
	partition_matrix <- do.call(cbind, partition)
	plot(NULL, NULL, xlim = c(1, Tm), ylim = c(1, N)+c(-0.5,0.5),
	     xlab = "time", ylab = "units",
	     xaxt = "n", yaxt = "n", main = title)
	axis(1, at = 1:Tm, labels = 1:Tm)
	for (t in 1:Tm) {
	  for (unit in 1:N) {
	    text(x = t, y = unit, 
	    	 # labels = as.character(unit),
	    	 labels = pchs[unit],
	         col = partition_matrix[unit, t], cex = cex)
	  }
	}
}

plot_ARI = function(partition,title){
	LEN = Tm
	df_cluster = data.frame(clusters=c(),Time=c())
	for(time in 1:Tm){
		salso_out <- partition[[time]]
		df_temp = data.frame(
			clusters = salso_out
		)
		df_temp$Time = rep(time,dim(df_temp)[1])
		df_cluster = rbind(df_cluster,df_temp)
		# clusters log
		# clusters_now = df_temp$clusters
		# n_clusters = unique(clusters_now)
		# cat(crayon::red("Time",time,"- #clusters =",length(unique(clusters_now)),"\n"))
	}
	library(mclust)
	# build the ARI matrix
	ARImats <- matrix(NA, nrow=LEN, ncol=LEN)
	rho_ARI <- list()
	for(k in 1:LEN){
		rho_ARI[[k]] <- partition[[k]]
	}
	for(k in 1: LEN){
		for(kk in 1: LEN){
			ARImats[k,kk] <- adjustedRandIndex(rho_ARI[[k]], rho_ARI[[kk]])
		}
	}
	ncols_ari = 100
	# if (min(ARImats)<0){
		# cols_ARI = colora(ncols_ari,79,0)
		# brks = seq(min(-1,floor(min(ARImats))),1,length.out=ncols_ari+1)
	# } else {
		# cols_ARI = colora(ncols_ari,56,0)
		# cols_ARI = rev(cols_ARI) # must be ordered from cold to warm
		cols_ARI = rev(colora(ncols_ari,104,0)) # or 109
		# cols_ARI = colora(ncols_ari,102,0)
		# brks = seq(0,1,length.out=ncols_ari+1)
		brks = seq(min(-1,floor(min(ARImats))),1,length.out=ncols_ari+1)
	# }
	# or see ?designer.colors for colors
	library(fields)
	image.plot(ARImats,
			   main=paste0("Lagged ARI values - ",title),axes=FALSE,col=cols_ARI,
			   breaks=brks)
	mtext(text=c(paste("",1:LEN)), side=2, line=0.3,at=seq(0,1,length=LEN), las=1, cex=0.8)
	mtext(text=c(paste("",1:LEN)), side=1, line=0.3,at=seq(0,1,length=LEN), las=2, cex=0.8)
}

overlay_clusters = function(y_data,partition,title="",cexs=0.8){
par(mar=c(2,2,2,1))
for(i in 1:size(y_data)[1]){
   if(i==1){
     plot(1:size(y_data)[2],y_data[i,],col=cols[i],ylim=extrema(y_data),type='l',
     	 xlab='time',main=title)
 	  } 
	  else{
		  lines(1:size(y_data)[2],y_data[i,],col=cols[i])
	  }
}
partition_matrix <- do.call(cbind, partition)
for(i in 1:N){
	for (t in 1:Tm){
		points(t,y_data[i,t],col=partition_matrix[i, t],
			   pch=19,cex=cexs)
	}
}
}
```


## Partition plots

```{r}
# load("df wsc fits/space_drpm1_run1.Rdata")
load("df wsc fits/space_drpm1_run6.Rdata") # final choice since really same model

# load("df wsc fits/space_rout_full_run1_dfweekly.Rdata") # bad
# load("df wsc fits/space_rout_full_run2_dfweekly.Rdata") # better
# load("df wsc fits/space_rout_full_run3_dfweekly.Rdata") # better better
# load("df wsc fits/space_rout_full_run4_dfweekly.Rdata") # bad
# load("df wsc fits/space_rout_full_run5_dfweekly.Rdata")
load("df wsc fits/space_rout_full_run6_dfweekly.Rdata") # final choice since really same model
```

```{r,warning=F}
# partition_plots = function(drpm1, rout){ 
# Initialize a list to store the partitions for each time instant
partitions_drpmc <- generate_partition(drpm1, loss ="binder",maxcl = 0)
partitions_drpmj <- generate_partition(rout , loss ="binder",maxcl = 0)

save_plots=F

# partition_matrix <- do.call(cbind, partitions)
# if (save_plots==T){
# 	pdf(file="partizioni_chars.pdf",width=12,height = 6)
# }
# par(mar=c(4,1,3,1),mfrow=c(1,2),oma=c(1,0.5,0.5,0.5))
# plot_partition_with_chars(partitions_drpmc, title="model C")
# plot_partition_with_chars(partitions_drpmj, title="model J")
# if (save_plots==T){ dev.off()}

if (save_plots==T){
	pdf(file="ari.pdf",width=10,height = 5)
}
par(mar=c(2,2,2,2),mfrow=c(1,2),oma=c(0.1,0.1,0.1,2))
plot_ARI(partitions_drpmc, title="model C")
plot_ARI(partitions_drpmj, title="model J")
if (save_plots==T){ dev.off()}


if (save_plots==T){
	pdf(file="partizioni_nums.pdf",width=10,height = 6)
	# pdf(file="partizioni_nums_higher.pdf",width=10,height = 5)
}
par(mar=c(3.2,1,2,1),mfrow=c(1,2),oma=c(0.1,0.1,0.1,0.1))
plot_partition_with_numbers(partitions_drpmc, title="model C",cex=0.7,line=2.1)
plot_partition_with_numbers(partitions_drpmj, title="model J",cex=0.7,line=2.1)
if (save_plots==T){ dev.off()}
```

maybe better partition numbers plot
```{r}
par(mar=c(3.2,1,2,1),mfrow=c(1,2),oma=c(0.1,0.1,0.1,0.1))

rho <- list()
for(k in 1:12){
  rho[[k]] <-partitions_drpmc[[k]]
}
header="model C"
plot(rep(1:12, each=nrow(y)), rep(1:105, times=ncol(y)), type='n',
   yaxt="n",ylab="", xlab="time", main=header, cex.main=2, cex.lab=1.75,
   xaxt="n")
axis(side=1, at=1:12, cex.axis=1.5)
for(jj in 1:ncol(y)){
	ord <- order(rho[[jj]])
	cex1 <- rep(0.8,length(ord))
	text(rep(jj, each=nrow(y)), 1:105, labels=19, col=rho[[jj]][ord], cex=cex1[ord])
}

rho <- list()
for(k in 1:12){
  rho[[k]] <-partitions_drpmj[[k]]
}
header="model J"
plot(rep(1:12, each=nrow(y)), rep(1:105, times=ncol(y)), type='n',
   yaxt="n",ylab="", xlab="time", main=header, cex.main=2, cex.lab=1.75,
   xaxt="n")
axis(side=1, at=1:12, cex.axis=1.5)
for(jj in 1:ncol(y)){
	ord <- order(rho[[jj]])
	cex1 <- rep(0.8,length(ord))
	text(rep(jj, each=nrow(y)), 1:105, labels=19, col=rho[[jj]][ord], cex=cex1[ord])
}

```


# fitted values
```{r}
yredC=t(drpm1$fitted[,,size(drpm1$fitted)[3]])
yredJ=t(rout$fitted[,,size(rout$fitted)[3]])
yredORIG=y

save_plots=F

if (save_plots==TRUE) {
	pdf(file="C_mean_prediction.pdf",height = 6,width=11)
	# pdf(file="C_median_prediction.pdf",height = 6,width=10)
	# pdf(file="C_last_iteration.pdf",height = 6,width=10)
}
##### take the median/mean/mode
summary_fitted = t(drpm1$fitted[,,size(drpm1$fitted)[3]])*0
for(j in 1:N){
	# cat(j,"of",N,"\r")
	for(t in 1:Tm){
		# values_j = c()
		# for (it in 1:size(drpm1$fitted)[3]){
			# values_j = c(values_j,drpm1$fitted[t,j,it])
		# }
		summary_fitted[j,t] = mean(drpm1$fitted[t,j,])
		# summary_fitted[j,t] = mean(values_j)
		# summary_fitted[j,t] = median(values_j)
		# summary_fitted[j,t] = Mode(values_j) # function from include.R
	}
}
yred=summary_fitted
# take last sample (maybe not the best choice)
# yred=t(drpm1$fitted[,,size(drpm1$fitted)[3]])

par(mar=c(2,2,2,1))
# cols = colora(size(yred)[1],56,0)
# cols = colora(N,"div",0)
# cols = colora(N,"div",seed_div = "Paired",show = 0)
cols = colora(N,56,0)
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],
     	 ylim=extrema(yredJ,yredC,yredORIG),type='l',xlab='',ylab="",
     	 # main="C fitted values - last iteration")
     	 main="C fitted values - iterations mean")
     	 # main="C fitted values - iterations median")
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}
if (save_plots==TRUE) { dev.off()}
#################################################################
if (save_plots==TRUE) { 
	pdf(file="J_mean_prediction.pdf",height = 6,width=11)
	# pdf(file="J_median_prediction.pdf",height = 6,width=10)
	# pdf(file="J_last_iteration.pdf",height = 6,width=10)
}
summary_fitted = t(rout$fitted[,,size(rout$fitted)[3]])*0
for(j in 1:N){
	# cat(j,"of",N,"\r")
	for(t in 1:Tm){
		# values_j = c()
		# for (it in 1:size(rout$fitted)[3]){
			# values_j = c(values_j,rout$fitted[t,j,it])
		# }
		summary_fitted[j,t] = mean(rout$fitted[t,j,])
		# summary_fitted[j,t] = mean(values_j)
		# summary_fitted[j,t] = median(values_j)
		# summary_fitted[j,t] = Mode(values_j) # function from include.R
	}
}
yred=summary_fitted
# take last sample (maybe not the best choice)
# yred=t(rout$fitted[,,size(rout$fitted)[3]])

par(mar=c(2,2,2,1))
# cols = colora(size(yred)[1],56,0)
# cols = colora(N,"div",0)
cols = colora(N,56,0)
# cols = colora(N,"div",seed_div = "Paired",show = 0)
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],
     	 ylim=extrema(yredJ,yredC,yredORIG),type='l',xlab='',ylab="",
     	 # main="J fitted values - last iteration")
     	 main="J fitted values - iterations mean")
     	 # main="J fitted values - iterations median")
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}
if (save_plots==TRUE) { dev.off() }
#################################################################


yred=y
# cols = colora(N,"div",0)
cols = colora(N,56,0)
# cols = colora(N,"div",seed_div = "Paired",show = 0)
if (save_plots==TRUE) { 
	pdf(file="test_2_spatial_data.pdf",height = 6,width=11)
}
par(mar=c(2,2,2,1))
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],ylim=extrema(yredJ,yredC,yredORIG),type='l',
     	 xlab='time',
     	 main='Spatio-temporal PM10 values')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}
# pchs
# offsets = c(-0.1,-0.2,0,0,0,0.2,0,0,0.1,0.3)
# for(i in 1:N){
# 	text(12.1,yred[i,12]+offsets[i],label=pchs[i],col=cols[i],cex=0.8)
# }
# offsets = c(-0.2,-0.4,0.1,0.7,0.82,-0.8,0,0,0.2,0.1)
# for(i in 1:N){
# 	text(0.92,yred[i,1]+offsets[i],label=pchs[i],col=cols[i],cex=0.8)
# }
# legend("bottom", legend = paste("unit", 1:size(yred)[1]), col = cols,
# 	   lty = 1,lwd=2,
# 	   cex=0.8, bty="n",
# 	   ncol=5)
if (save_plots==TRUE) { dev.off()}
```

# clusters
```{r}
yred=y
# cols = colora(N,"div",0)
cols = colora(N,56,0)
# cols = colora(N,"div",seed_div = "Paired",show = 0)
cexs = 0.7

save_plots=F

if (save_plots==TRUE) { 
	pdf(file="clusters_C.pdf",height = 6,width=11)
}
par(mar=c(2,2,2,1))
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],ylim=extrema(yredJ,yredC,yredORIG),type='l',
     	 xlab='time',
     	 main='Clusters according to model C-DRPM')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}
partition = partitions_drpmc
# partition = partitions_drpmj
partition_matrix <- do.call(cbind, partition)
for(i in 1:N){
	for (t in 1:Tm){
		points(t,yred[i,t],col=partition_matrix[i, t],pch=19,cex=cexs)
	}
}
if (save_plots==TRUE) { dev.off() }

# yred=y
# cols = colora(N,"div",0)
if (save_plots==TRUE) { 
	pdf(file="clusters_J.pdf",height = 6,width=11)
}
par(mar=c(2,2,2,1))
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],ylim=extrema(yredJ,yredC,yredORIG),type='l',
     	 xlab='time',
     	 main='Clusters according to model J-DRPM')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}

# partition = partitions_drpmc
partition = partitions_drpmj
partition_matrix <- do.call(cbind, partition)
for(i in 1:N){
	for (t in 1:Tm){
		points(t,yred[i,t],col=partition_matrix[i, t],
			   pch=19,cex=cexs)
	}
}
if (save_plots==TRUE) { dev.off() }
```

```{r}
scala_cex_y = function(y_curr,y_all){
	# scala =
	# out = log(y_curr + 4) + 0.3
	# out = 1 + 2 * sqrt(y_curr - min(y_all)) / sqrt(max(y_all) - min(y_all))
	# out = exp(y_curr +2.2 - min(y_all)) / exp(max(y_all) - min(y_all))
	# return((y_curr+abs(min(y_all)))/(extrema(y_all)+abs(min(y_all)))[2]*2+0.5)
	out = (y_curr-min(y_all))/(max(y_all)-min(y_all)) # in [0,1] now
	return(out+1)
}

for(t in 1:Tm){
	par(mfrow=c(1,2),mar=c(2,2,3,1))
	partition = partitions_drpmj
	partition_matrix <- do.call(cbind, partition)
	plot(s_std[1,1],s_std[1,2],col=partition_matrix[1,t],pch=19,
		 xlim=extrema(s_std[,1]),main=paste("model J - time",t),
		 ylim=extrema(s_std[,2]),
		 # cex=((y[1,t]-mean(y[,t]))/sd(y[,t])+3)/2)
		 # cex=y[1,t]+abs(min(y[,t])))
		  cex=scala_cex_y(y[1,t],y))
	for (i in 1:N){
		points(s_std[i,1],s_std[i,2],col=partition_matrix[i,t],pch=19,
			   # cex=((y[i,t]-mean(y[,t]))/sd(y[,t])+3)/2)
			   # cex=y[i,t]+abs(min(y[,t])))
			    cex=scala_cex_y(y[i,t],y))
	}
	partition = partitions_drpmc
	partition_matrix <- do.call(cbind, partition)
	plot(s_std[1,1],s_std[1,2],col=partition_matrix[1,t],pch=19,
		 xlim=extrema(s_std[,1]),main=paste("model C - time",t),
		 ylim=extrema(s_std[,2]),
		 # cex=((y[1,t]-mean(y[,t]))/sd(y[,t])+3)/2)
		 # cex=y[1,t]+abs(min(y[,t])))
		  cex=scala_cex_y(y[1,t],y))
	for (i in 1:N){
		points(s_std[i,1],s_std[i,2],col=partition_matrix[i,t],pch=19,
			   # cex=((y[i,t]-mean(y[,t]))/sd(y[,t])+3)/2)
			   # cex=y[i,t]+abs(min(y[,t])))
			   cex=scala_cex_y(y[i,t],y))
		# cat(scala_cex_y(y[i,t],y),"\n")
	}
}
```

# NICE MAP 1
the simple one
```{r}
folder = "spaceC/"
name = "CDRPM target + space"
load("./df wsc fits/space_drpm1_run6.Rdata")
partition = partitions_drpmc = generate_partition(drpm1, loss ="binder",maxcl = 0)

# folder = "spaceJ/"
# name = "JDRPM target + space"
# partition = partitions_drpmj

save_plot = T

if (save_plot==TRUE) {pdf(file=paste0(folder,"fit",name,"_simple_map.pdf"),
						  height =7, width = 9)}
par(mfrow=c(3,4),mar=c(1.5,2,2,1),oma=c(1,1,2,1))
for(t in 1:Tm){
	
	partition_matrix <- do.call(cbind, partition)
	plot(s_std[1,1],s_std[1,2],col=partition_matrix[1,t],pch=19,
		 xlim=extrema(s_std[,1]),main=paste("time",t),
		 ylim=extrema(s_std[,2]),
		 # cex=((y[1,t]-mean(y[,t]))/sd(y[,t])+3)/2)
		 # cex=y[1,t]+abs(min(y[,t])))
		  cex=1.2)
	for (i in 1:N){
		points(s_std[i,1],s_std[i,2],col=partition_matrix[i,t],pch=19,
			   # cex=((y[i,t]-mean(y[,t]))/sd(y[,t])+3)/2)
			   # cex=y[i,t]+abs(min(y[,t])))
			    cex=1.2)
	}
}
# [1] "#070707" "#2E1831" "#402E56" "#404B7B" "#036D9B" "#0092B2" "#00AFB2" "#60C8B6"
 # [9] "#A8DFC5" "#E0F7E1"
mtext(name,side=3,line=0,outer=T,col="#2E1831")
if (save_plot==TRUE) {dev.off()}
```




# compute mse
```{r}
yredORIGI=y
MSE_matrices = function(m1,m2){
	MSE = 0
	for (i in 1:size(m1)[1]){
		for (t in 1:size(m1)[2]){
			MSE = MSE + (m1[i,t]-m2[i,t])^2
		}
	}
	MSE = MSE/(size(m1)[1]*size(m1)[2])
	return(MSE)
}

##### take the median/mean/mode
summary_fitted_mean = t(drpm1$fitted[,,size(rout$fitted)[3]])*0
summary_fitted_median = t(drpm1$fitted[,,size(rout$fitted)[3]])*0
for(j in 1:N){
	for(t in 1:Tm){
		# values_j = c()
		# for (it in 1:size(drpm1$fitted)[3]){
			# values_j = c(values_j,drpm1$fitted[t,j,it])
		# }
		summary_fitted_mean[j,t] = mean(drpm1$fitted[t,j,])
		summary_fitted_median[j,t] = median(drpm1$fitted[t,j,])
		# summary_fitted[j,t] = Mode(values_j) # function from include.R
	}
}
cat("C MSE\n")
cat("mean ", MSE_matrices(summary_fitted_mean,yredORIGI),"\n")
cat("median ", MSE_matrices(summary_fitted_median,yredORIGI),"\n")
# take last sample (maybe not the best choice)
# yredC=t(drpm1$fitted[,,size(drpm1$fitted)[3]])
#################################################################
summary_fitted_mean = t(rout$fitted[,,size(rout$fitted)[3]])*0
summary_fitted_median = t(rout$fitted[,,size(rout$fitted)[3]])*0
for(j in 1:N){
	for(t in 1:Tm){
		# values_j = c()
		# for (it in 1:size(rout$fitted)[3]){
			# values_j = c(values_j,rout$fitted[t,j,it])
		# }
		summary_fitted_mean[j,t] = mean(rout$fitted[t,j,])
		summary_fitted_median[j,t] = median(rout$fitted[t,j,])
		# summary_fitted[j,t] = Mode(values_j) # function from include.R
	}
}
# take last sample (maybe not the best choice)
# yredJ=t(rout$fitted[,,size(rout$fitted)[3]])
#################################################################
cat("J MSE\n")
cat("mean ", MSE_matrices(summary_fitted_mean,yredORIGI),"\n")
cat("median ", MSE_matrices(summary_fitted_median,yredORIGI),"\n")
```


## ari pairwise
```{r,warning=F}
LEN = Tm
compare_ARI = function(Cmod1,Jmod2){
	ARIvec <- matrix(NA, nrow=1, ncol=LEN)
		rhoC = generate_partition(Cmod1)
		rhoJ = generate_partition(Jmod2)
	for(k in 1: LEN){
		cat(k,"\r")
		ARIvec[k] <- adjustedRandIndex(rhoC[[k]][1:N], rhoJ[[k]][1:N])
	}	
	ncols_ari = 100
	cols_ARI = colora(ncols_ari,79,0)
	# cols_ARI = rev(cols_ARI)
	brks = seq(-1,1,length.out=ncols_ari+1)
	# pdf(paste0("./figures/DRPM/ARI/ari.pdf"), height=8, width=10)
	# svg(paste0("./figures/",base_folder,"/ARI/ari.svg"), height=8, width=10)
	# png(paste0("./figures/",base_folder,"/ARI/ari.png"),  width=700,height=600)
	library(fields)
	# plot(1:Tm,ARIvec,type="l",main=paste0("ARI values"),ylim=c(-0.5,1))
	par(mar=c(2,2,2,1))
	plot(1:Tm,ARIvec,type="l",
		 main=bquote("ARI values " * rho[J] * "(t) vs " * rho[C] * "(t)"),ylim=c(-0.5,1))
	abline(h=0,  col="#888888",lty=3,lwd=2)
	abline(h=0.5,col="#dddddd",lty=3,lwd=2)
	
	# image.plot(ARIvec,
	# 		   main=paste0("ARI values - ",mod1," vs ",mod2),axes=FALSE,col=cols_ARI,
	# 		   breaks=brks)
	# mtext(text=c(paste("",1:LEN)), side=2, line=0.3,at=seq(0,1,length=LEN), las=1, cex=0.8)
	return(ARIvec)
}

mods = c("DRPM","sPPM","Gaussian PPMx","Curve PPMx")
Cmod1 = drpm1
Jmod2 = rout
ariv = compare_ARI(Cmod1,Jmod2)
cat("mean ",mean(ariv),"\n")
cat("median ",median(ariv))
```

# covariate effect (if any)
```{r}
#########################################
titleJ = "model J - considering Altitude when clustering"
# titleJ = "model J - ignoring covariates when clustering"
partition = partitions_drpmj
# titleJ = "model C"
# partition = partitions_drpmc
#########################################


# pdf(paste0("../../tmp_images/",titleJ,".pdf"),width = 8, height = 5)
# png(paste0("../../tmp_images/",titleJ,".png"), width = 500, height = 300,units = "px")
par(mar=c(4,4,2,1))
time=1
maxk = 5
##### if fitted with Xcl
# mean(X_cl[which(partition[[time]]==1),,1])
# mean(X_cl[which(partition[[time]]==2),,1])
# mean(X_cl[which(partition[[time]]==3),,1])
# plot(X_cl[,,1],pch=19,col=partition[[time]],
# 	 main=paste0("time=",time," - ",titleJ),xlab="units",ylab="Altitude")

cols = cols_copy = colora(maxk,"div",seed_div = "Paired",show = 0)
# cols = cols_copy = colora(maxk,80,show=0)
cols[1] = cols_copy[2]
cols[2] = cols_copy[1]
##### otherwise
cova_of_interest = as.data.frame(df_wsc[df_wsc$Time == unique(df_wsc$Time)[time],"Altitude"])
plot(cova_of_interest[,1],
	col=cols[partition[[time]]],
	# col=partition[[time]],
	pch=19,
	# cex=pmax(y[, time]*4, rep(0.7, N)),
	main=paste0("time=",time," - ",titleJ),xlab="units",ylab="Altitude"
	)

# dev.off()

#########################################
# titleJ = "model J - considering Altitude when clustering"
# titleJ = "model J - ignoring covariates when clustering"
# partition = partitions_drpmj
titleJ = "model C"
partition = partitions_drpmc
#########################################


# pdf(paste0("../../tmp_images/",titleJ,".pdf"),width = 8, height = 5)
# png(paste0("../../tmp_images/",titleJ,".png"), width = 500, height = 300,units = "px")
par(mar=c(4,4,2,1))
time=1
##### if fitted with Xcl
# mean(X_cl[which(partition[[time]]==1),,1])
# mean(X_cl[which(partition[[time]]==2),,1])
# mean(X_cl[which(partition[[time]]==3),,1])
# plot(X_cl[,,1],pch=19,col=partition[[time]],
# 	 main=paste0("time=",time," - ",titleJ),xlab="units",ylab="Altitude")

cols = colora(maxk,"div",seed_div = "Paired",show = 0)
##### otherwise
cova_of_interest = as.data.frame(df_wsc[df_wsc$Time == unique(df_wsc$Time)[time],"Altitude"])
plot(cova_of_interest[,1],
	col=cols[partition[[time]]],
	# col=partition[[time]],
	pch=19,
	# cex=pmax(y[, time]*4, rep(0.7, N)),
	main=paste0("time=",time," - ",titleJ),xlab="units",ylab="Altitude"
	)

# dev.off()
```


#-------------
## salso plots
```{r}
##########################
model_name = "model C"
partition = partitions_drpmc
# model_name = "model J"
# partition = partitions_drpmj
##########################

par(mar=c(1,1,1,1))
for (time in 1:Tm){
	salso_out = partition[[time]]
	ssout = summary(salso_out)
	# plot(ssout,type="heatmap")
	# plot(ssout,type="mds")
	plot(ssout,type="pairs",data=s_std)
	text(0.3,0.91,pos=3,paste0(model_name," - Time ",time))
	# plot(ssout,type="dendrogram")
	# dev.off()
}


##########################
# model_name = "model C"
# partition = partitions_drpmc
model_name = "model J"
partition = partitions_drpmj
##########################

par(mar=c(1,1,1,1))
for (time in 1:Tm){
	salso_out = partition[[time]]
	ssout = summary(salso_out)
	# plot(ssout,type="heatmap")
	# plot(ssout,type="mds")
	plot(ssout,type="pairs",data=s_std)
	text(0.3,0.91,pos=3,paste0(model_name," - Time ",time))
	# plot(ssout,type="dendrogram")
	# dev.off()
}
```


## PM10 plots
```{r warning=FALSE}
setwd("../src/")
# preparation
source("include.R")
source("plot functions/plotter.R")
source("include_clusters_functions.R")
```

```{r}
# load("../thesis data/df_daily_full_logtransf.Rdata")
# df_wsc = df_daily_full_logtransf
# df_wsc$IDStations[which(df_wsc$IDStations=="STA-CH0011A")] = "STA.CH0011A"
# df_wsc$IDStations[which(df_wsc$IDStations=="STA-CH0033A")] = "STA.CH0033A"
# df_wsc$IDStations[which(df_wsc$IDStations=="STA-CH0043A")] = "STA.CH0043A"


sites = data.frame(
	longitude = unique(df_weekly$Longitude), 
	latitude = unique(df_weekly$Latitude))
std_sites = data.frame(
	longitude = unique(df_wsc$Longitude), 
	latitude = unique(df_wsc$Latitude))
sites_full = data.frame(
	longitude = unique(df_wsc$Longitude), 
	latitude = unique(df_wsc$Latitude))
stations = unique(df_wsc$IDStations)
yfull=data.frame()

target = "AQ_pm10"
# target = "WE_tot_precipitation"

for(st in stations){
	y_we_pm10=cbind(as.data.frame(st),t(df_wsc[which(df_wsc$IDStations==st),target]))
	yfull=rbind(yfull,y_we_pm10)
}
rownames(yfull) = NULL
colnames(yfull)<- c("id",paste0("w", 1:(size(yfull)[2]-1)))
# time_span = 1:14 # GOOD
# time_span = 1:4
time_span = 1:12

set.seed(110)
# quanti = 80; nsubjects = sample(1:105, quanti,replace = F)
# quanti = 30; nsubjects = sample(1:105, quanti,replace = F) #GOOD
# quanti = 60; nsubjects = sample(1:105, quanti,replace = F)
nsubjects = 1:105

y = yfull[nsubjects,1+time_span]
#############################################
# authors suggested to/did scale the spatial locations and also centered the observations

mn <- apply(y,2,mean)
sd <- apply(y,2,sd)

y <- t(t(y) - mn)

Tm = tps <- ncol(y) # time span
N = size(y)[1] # number of units
num_units = N

sites_tmp = sites_full[nsubjects,]
smn <- apply(sites_tmp,2,mean)
ssd <- apply(sites_tmp,2,sd)
s_std <- t((t(sites_tmp) - smn)/ssd)

# check
# mean(s_std[,1])
# mean(s_std[,2])
# var(s_std[,2])
# var(s_std[,1])
######################################
time_span = 1:Tm
```


## plot j
```{r,warning=F}
##########################
# model_name = "model C"
# partition = partitions_drpmc
model_name = "model J6"
partition = partitions_drpmj
limt = 2
##########################
df_cluster = data.frame(Longitude=c(),Latitude=c(),values=c(),clusters=c(),Time=c())
for(time in time_span[1:limt]){

	salso_out <- partition[[time]]
	
	df_temp = data.frame(
		Longitude = sites$longitude,
		Latitude = sites$latitude,
		clusters = salso_out[1:105]
	)
	
	# idxs = which(is.na(df_temp$clusters))
	# replace(df_temp$clusters, idxs, 3)
	# df_temp$clusters[idxs] = max(na.omit(df_temp$clusters))+1
	
	df_temp$Time = rep(time,dim(df_temp)[1])
	df_cluster = rbind(df_cluster,df_temp)
	
	# clusters log
	clusters_now = df_temp$clusters
	n_clusters = unique(clusters_now)
	ycurrent = y[,paste0("w",time)]
	cat(crayon::red("Time",time,"- #clusters =",length(unique(clusters_now)),"\n"))
}

plots_J = list()
clusters_old = NULL
for(time in time_span[1:limt]){
	cat(crayon::red("Time",time,"of",Tm,"\n"))
	
	df_cluster_cut = df_cluster[df_cluster$Time==time,]
	clusters_now = df_cluster_cut$clusters
	####### no mode correct now
	# clusters_now = mode_correct_clusters(clusters_old,clusters_now,very_verbose = 0)
	# se fai heat plot non serve fare la mode correct
	# perchÃ© la heat plot la usi per vedere anche i valori di pm10, non la coerenza temporale
	# nei gruppi, che con la heat coloration si perde come visibilitÃ  (non so se Ã¨ chiaro)
	df_cluster_cut$clusters = clusters_now
	
	# meglio l'idea 1
	cols = color_correct_clusters(df_cluster_cut,idea=1,verbose=0)
	
	
	# q = get_graph_plot(df_cluster_cut,cols)
	# print(q)

	p = plot_graph_and_hist(df_cluster_cut,cols,titolo = model_name)
	# print(p)
		
	# plot_intensities(df_cluster_cut)

	# pl = get_hist_continuos_plot(df_cluster_cut) # a bit less nice than nice
	# pl = get_hist_color_plot(df_cluster_cut) # bad	
	# pl = get_hist_fill_plot(df_cluster_cut) # nice
	# pl = get_boxplot_plot(df_cluster_cut,cols)
	# print(pl)
	
	# plx = get_boxplot_covariate_plot(df_cluster_cut,cols,
	# 								# covariata = "AQ_pm10", # clasic boxplot of other functions
	# 								covariata = "Altitude", # clasic boxplot
	# 								# covariata = "LA_lvi", # clasic boxplot
	# annotate = F)
	# print(plx)
		
	cur_num = sprintf("%02d", time)
	ggsave(file=paste0("./tmp_images/",model_name,"-Graph and Boxplot-",cur_num,".png"),
	plot=p, units="px",width=2500, height=1200, dpi=300)
	dev.off()
	
	clusters_old = clusters_now
}
```




## plot c
```{r}
##########################
model_name = "model C"
partition = partitions_drpmc
# model_name = "model J"
# partition = partitions_drpmj
limt = 12
##########################
df_cluster = data.frame(Longitude=c(),Latitude=c(),values=c(),clusters=c(),Time=c())
for(time in time_span[1:limt]){

	salso_out <- partition[[time]]
	
	df_temp = data.frame(
		Longitude = sites$longitude,
		Latitude = sites$latitude,
		clusters = salso_out[1:105]
	)
	
	# idxs = which(is.na(df_temp$clusters))
	# replace(df_temp$clusters, idxs, 3)
	# df_temp$clusters[idxs] = max(na.omit(df_temp$clusters))+1
	
	df_temp$Time = rep(time,dim(df_temp)[1])
	df_cluster = rbind(df_cluster,df_temp)
	
	# clusters log
	clusters_now = df_temp$clusters
	n_clusters = unique(clusters_now)
	ycurrent = y[,paste0("w",time)]
	cat(crayon::red("Time",time,"- #clusters =",length(unique(clusters_now)),"\n"))
}

clusters_old = NULL
for(time in time_span[1:limt]){
	cat(crayon::red("Time",time,"of",Tm,"\n"))
	
	df_cluster_cut = df_cluster[df_cluster$Time==time,]
	clusters_now = df_cluster_cut$clusters
	####### no mode correct now
	# clusters_now = mode_correct_clusters(clusters_old,clusters_now,very_verbose = 0)
	# se fai heat plot non serve fare la mode correct
	# perchÃ© la heat plot la usi per vedere anche i valori di pm10, non la coerenza temporale
	# nei gruppi, che con la heat coloration si perde come visibilitÃ  (non so se Ã¨ chiaro)
	df_cluster_cut$clusters = clusters_now
	
	# meglio l'idea 1
	cols = color_correct_clusters(df_cluster_cut,idea=1,verbose=0)
	
	
	# q = get_graph_plot(df_cluster_cut,cols)
	# print(q)

	p = plot_graph_and_hist(df_cluster_cut,cols,titolo = model_name)
	print(p)
	
	# plot_intensities(df_cluster_cut)

	# pl = get_hist_continuos_plot(df_cluster_cut) # a bit less nice than nice
	# pl = get_hist_color_plot(df_cluster_cut) # bad	
	# pl = get_hist_fill_plot(df_cluster_cut) # nice
	# pl = get_boxplot_plot(df_cluster_cut,cols)
	# print(pl)
	
	# plx = get_boxplot_covariate_plot(df_cluster_cut,cols,
	# 								# covariata = "AQ_pm10", # clasic boxplot of other functions
	# 								# covariata = "Altitude", # clasic boxplot
	# 								covariata = "LA_lvi", # clasic boxplot
									# annotate = F)
	# print(plx)
		
	cur_num = sprintf("%02d", time)
	ggsave(file=paste0("./tmp_images/",model_name,"-Graph and Boxplot-",cur_num,".png"),
	plot=p, units="px",width=2500, height=1200, dpi=300)
	dev.off()
	
	clusters_old = clusters_now
}
```



```{r}
partition = partitions_drpmj
partition_matrix <- do.call(cbind, partition)

# target_col = "AQ_pm10"
target_col = "Altitude"

times = unique(df_wsc$Time)
for (t in c(1,2,3)){
df_time_t = df_wsc[df_wsc$Time == times[t],]
boxplot(df_time_t[,target_col] ~ partition_matrix[,t],)
}

```



```{r}
#########################################
# titleJ = "model J - considering Altitude when clustering"
titleJ = "model J - ignoring covariates when clustering"
partition = partitions_drpmj
titleJ = "model C"
partition = partitions_drpmc
#########################################


pdf(paste0("../../tmp_images/",titleJ,".pdf"),width = 8, height = 5)
# png(paste0("../../tmp_images/",titleJ,".png"), width = 500, height = 300,units = "px")
par(mar=c(4,4,2,1))
time=1

##### if fitted with Xcl
# mean(X_cl[which(partition[[time]]==1),,1])
# mean(X_cl[which(partition[[time]]==2),,1])
# mean(X_cl[which(partition[[time]]==3),,1])
# plot(X_cl[,,1],pch=19,col=partition[[time]],
# 	 main=paste0("time=",time," - ",titleJ),xlab="units",ylab="Altitude")

cols = colora(maxk,34,0)
##### otherwise
cova_of_interest = as.data.frame(df_wsc[df_wsc$Time == unique(df_wsc$Time)[time],"Altitude"])
plot(cova_of_interest[,1],
	# col=cols[partition[[time]]],
	col=partition[[time]],
	pch=19,
	# cex=pmax(y[, time]*4, rep(0.7, N)),
	main=paste0("time=",time," - ",titleJ),xlab="units",ylab="Altitude"
	)

dev.off()
```


# NICE MAP 2
```{r}
library(gridExtra)
##########################
model_name = "CDRPM target + space"
partition = partitions_drpmc
folder = "./spaceC/"
# 
# model_name = "JDRPM - target + space"
# partition = partitions_drpmj
# folder = "./spaceJ/"

limt = 2
##########################
df_cluster = data.frame(Longitude=c(),Latitude=c(),values=c(),clusters=c(),Time=c())
for(time in time_span[1:limt]){

	salso_out <- partition[[time]]
	
	df_temp = data.frame(
		Longitude = sites$longitude,
		Latitude = sites$latitude,
		clusters = salso_out[1:105]
	)
	
	# idxs = which(is.na(df_temp$clusters))
	# replace(df_temp$clusters, idxs, 3)
	# df_temp$clusters[idxs] = max(na.omit(df_temp$clusters))+1
	
	df_temp$Time = rep(time,dim(df_temp)[1])
	df_cluster = rbind(df_cluster,df_temp)
	
	# clusters log
	clusters_now = df_temp$clusters
	n_clusters = unique(clusters_now)
	ycurrent = y[,paste0("w",time)]
	cat(crayon::red("Time",time,"- #clusters =",length(unique(clusters_now)),"\n"))
}

clusters_old = NULL
for(time in time_span[1:limt]){
	cat(crayon::red("Time",time,"of",Tm,"\n"))
	
	df_cluster_cut = df_cluster[df_cluster$Time==time,]
	clusters_now = df_cluster_cut$clusters
	####### no mode correct now
	# clusters_now = mode_correct_clusters(clusters_old,clusters_now,very_verbose = 0)
	# se fai heat plot non serve fare la mode correct
	# perchÃ© la heat plot la usi per vedere anche i valori di pm10, non la coerenza temporale
	# nei gruppi, che con la heat coloration si perde come visibilitÃ  (non so se Ã¨ chiaro)
	df_cluster_cut$clusters = clusters_now
	
	# meglio l'idea 1
	cols = color_correct_clusters(df_cluster_cut,idea=1,verbose=0)
	
	cur_num = sprintf("%02d", time)

plot1 <- get_graph_plot(df_cluster_cut,cols,titolo=paste0(model_name," - time ",time))

covariata = "AQ_pm10"
plot2 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

covariata = "WE_wind_speed_10m_max"
plot3 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

covariata = "WE_tot_precipitation"
plot4 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

covariata = "WE_blh_layer_max"
plot5 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

covariata = "EM_nh3_sum"
plot6 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

covariata = "Altitude"
plot7 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

# g <- arrangeGrob(
# 	plot1, plot2, plot3, plot4, plot5,
# 			   widths = c(2, 1, 1),
#   layout_matrix = rbind(c(1, 2, 3),
#                         c(1, 4, 5)))

g <- arrangeGrob(
	plot1, plot2, plot3, plot4, plot5, plot6, plot7,
			   # widths = c(1, 1, 1, 1),
			  heights = c(1, 1, 1.8, 1.8),
  # layout_matrix = rbind(c(1, 1, 2, 2),
                        # c(1, 1, 2, 2),
                        # c(3, 4, 5, 6) 
  layout_matrix = rbind(c(1, 1, 1, 1, 1, 2, 2, 2),
                        c(1, 1, 1, 1, 1, 2, 2, 2),
                        c(1, 1, 1, 1, 1, 7, 7, 7),
                        c(3, 3, 4, 4, 5, 5, 6, 6)
  					  ))

ggsave(file=paste0(folder,model_name,"_t",cur_num,".pdf"),plot = g,
	   # units="px",width=2500, height=1200, dpi=300)
	   # units="px",width=4500, height=2000, dpi=300)
	   # units="px",width=3600, height=1500, dpi=300)
	   # units="px",width=3000, height=2400, dpi=300)
	   units="px",width=3300, height=2600, dpi=300)
	   # units="px",width=2880, height=1200, dpi=300)
dev.off()
	
	clusters_old = clusters_now
}
```


# final plot c
```{r}
library(gridExtra)
##########################

limt = 12
##########################
df_cluster = data.frame(Longitude=c(),Latitude=c(),values=c(),clusters=c(),Time=c())
for(time in time_span[1:limt]){

	salso_out <- partition[[time]]
	
	df_temp = data.frame(
		Longitude = sites$longitude,
		Latitude = sites$latitude,
		clusters = salso_out[1:105]
	)
	
	# idxs = which(is.na(df_temp$clusters))
	# replace(df_temp$clusters, idxs, 3)
	# df_temp$clusters[idxs] = max(na.omit(df_temp$clusters))+1
	
	df_temp$Time = rep(time,dim(df_temp)[1])
	df_cluster = rbind(df_cluster,df_temp)
	
	# clusters log
	clusters_now = df_temp$clusters
	n_clusters = unique(clusters_now)
	ycurrent = y[,paste0("w",time)]
	cat(crayon::red("Time",time,"- #clusters =",length(unique(clusters_now)),"\n"))
}

clusters_old = NULL
for(time in time_span[1:limt]){
	cat(crayon::red("Time",time,"of",Tm,"\n"))
	
	df_cluster_cut = df_cluster[df_cluster$Time==time,]
	clusters_now = df_cluster_cut$clusters
	####### no mode correct now
	# clusters_now = mode_correct_clusters(clusters_old,clusters_now,very_verbose = 0)
	# se fai heat plot non serve fare la mode correct
	# perchÃ© la heat plot la usi per vedere anche i valori di pm10, non la coerenza temporale
	# nei gruppi, che con la heat coloration si perde come visibilitÃ  (non so se Ã¨ chiaro)
	df_cluster_cut$clusters = clusters_now
	
	# meglio l'idea 1
	cols = color_correct_clusters(df_cluster_cut,idea=1,verbose=0)
	
	cur_num = sprintf("%02d", time)

plot1 <- get_graph_plot(df_cluster_cut,cols,titolo=paste0(model_name," - time ",time))

covariata = "AQ_pm10"
plot2 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

covariata = "Altitude"
plot3 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

covariata = "LA_lvi"
plot4 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

covariata = "WE_tot_precipitation" # or
# covariata = "WE_blh_layer_max"
plot5 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

g <- arrangeGrob(
	plot1, plot2, plot3, plot4, plot5,
				widths = c(2, 1, 1),
  layout_matrix = rbind(c(1, 2, 3),
                        c(1, 4, 5)))

ggsave(file=paste0(folder,model_name,"_t",cur_num,".pdf"),plot = g,
	   # units="px",width=2500, height=1200, dpi=300)
	   # units="px",width=4500, height=2000, dpi=300)
	   # units="px",width=3600, height=1500, dpi=300)
	   units="px",width=2880, height=1200, dpi=300)
	   # units="px",width=3240, height=1350, dpi=300)
dev.off()
	
	clusters_old = clusters_now
}
```

# another layout
```{r}
plot1 <- get_graph_plot(df_cluster_cut,cols,titolo=paste0(model_name," - time ",time))

covariata = "AQ_pm10"
plot2 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

covariata = "Altitude"
plot3 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

covariata = "LA_lvi"
plot4 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

covariata = "WE_tot_precipitation" # or
# covariata = "WE_blh_layer_max"
plot5 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)

# covariata = "WE_tot_precipitation" # or
covariata = "WE_blh_layer_max"
plot6 = get_boxplot_covariate_plot(df_cluster_cut,cols,titolo=covariata,
covariata = covariata,annotate = F)


g <- arrangeGrob(
	plot1, plot2, plot3, plot4, plot5,plot6,
				widths = c(1,1,1,1),
			    heights = c(1,1,1.3),
  layout_matrix = rbind(c(1, 1, 1, 2),
  					    c(1, 1, 1, 2),
                        c(3, 4, 5, 6)))

ggsave(file=paste0(folder,"test",".pdf"),plot = g,
	   # units="px",width=2500, height=1200, dpi=300)
	   # units="px",width=4500, height=2000, dpi=300)
	   units="px",width=2900, height=2500, dpi=300)
dev.off()

```



# ===========
# with NA
## setting NA
```{r}
# Number of elements to set as NA
y_NA = y

ndata = size(y)[1] * size(y)[2]

# set.seed(123)
set.seed(181024)
na_percentage = 0.1
# na_percentage = 0.09620821
n_na <- round(ndata * na_percentage) # nstations * nday * na%
cat(n_na,"\n")

# Randomly sample positions to be set as NA
na_indices_j <- sample(size(y)[1], n_na,replace = T)
na_indices_t <- sample(size(y)[2], n_na,replace = T)

for (k in 1:n_na){
	# cat("NAing index (",na_indices_j[k],",",na_indices_t[k],")\n")
	y_NA[na_indices_j[k], na_indices_t[k]] = NA
}

# Check the dataset
cat(sum(is.na(y_NA)))
# y_NA

yred=y
# cols = colora(N,"div",0)
cols = colora(N,56,0)
# cols = colora(N,"div",seed_div = "Paired",show = 0)

save_plots=F

# yred=y
# cols = colora(N,"div",0)
if (save_plots==TRUE) { 
	pdf(file="clusters_J.pdf",height = 6,width=11)
}
par(mar=c(2,2,2,1))
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],ylim=extrema(yred),type='l',
     	 xlab='time',
     	 main='Clusters according to model J-DRPM (NA data)')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}

for(i in 1:N){
	for (t in 1:Tm){
		pchh = 19
		if (is.na(y_NA[i,t])){
			pchh = 17
			cexs = 1
			points(t,yred[i,t],col="black",pch=pchh,cex=cexs)
		}
	}
}
```

```{r}
module_JDRPM <- juliaImport(juliaCall("include", module))
module_JDRPM$trigger_compilation()
```


## drpm J
```{r}
a_sigma  = 0.01; b_sigma = 0.01
# a_tau    = 2.1; b_tau   = 0.9
# a_tau    = 1.7; b_tau   = 0.4
a_tau    = 1.9; b_tau   = 0.4
# a_lambda = 0.1; b_lambda = 0.1
a_lambda = 1.9; b_lambda = 0.4

# module_JDRPM <- juliaImport(juliaCall("include", module))
out = module_JDRPM$MCMC_fit(
	# Y=as.matrix(y),
	Y=as.matrix(y_NA),
	sp_coords = s_std,
	M_dp = 1,                     
	initial_partition = NA,
	Xlk_covariates = NA,
	Xcl_covariates = NA,
	
	starting_alpha = 0.5,         
	unit_specific_alpha = FALSE,       
	time_specific_alpha = TRUE,       
	update_alpha = TRUE,             
	
	include_eta1 = TRUE,                    
	include_phi1 = T,
	update_eta1 = update_eta1,                    
	update_phi1 = T,
	
	sig2h_priors = c(a_sigma,b_sigma),
	eta1_priors = c(eta1_scale,sig_mh_eta1),
	# beta_priors = c(rep(1,p),2),
	beta_priors = NA,
	tau2_priors = c(a_tau,b_tau),
	phi0_priors = c(m0_phi0,s20_phi0),
	phi1_priors = sig_mh_phi1,
	lambda2_priors = c(a_lambda,b_lambda),
	alpha_priors = c(a_alpha,b_alpha),  
	
	######## space
	spatial_cohesion_idx = spatial_cohesion,
	sp_params = list(c(mu0,mu0),k0,v0,matrix(c(L0,0.0,0.0,L0),nrow=2)),
	
	######## likelihood covariates
	Xlk_covariates = X_lk, beta_priors = c(rep(0,p),10),
	beta_update_threshold = as.integer(nburn/2),
	# Xlk_covariates = NA, beta_priors = NA,
	
	######## clustering covariates
	# covariate_similarity_idx = 4,
	# cv_params = list(0,1,2,2),
	# Xcl_covariates = X_cl,
	
	# spatial_cohesion_idx = 1,
	# sp_params = list(0.1),
	
	# covariate_similarity_idx = NA,
	draws = niter,burnin = nburn, thin = nthin,
	# draws = 200,burnin = 20, thin = 4,
	logging = F,
	seed = 111.0,
	simple_return = FALSE,
	verbose = T,
	perform_diagnostics = TRUE
)
```




## rout
```{r}
rout = juliaGet(out)
names(rout)  = c("Si",
				 "gamma",
				 "alpha",
				 "sigma2h",
				 "muh",
				 "eta1",
				 "beta",
				 "theta",
				 "tau2",
				 "phi0",
				 "phi1",
				 "lambda2",
				 "fitted",
				 "llike",
				 "lpml",
				 "waic")

# reshape some stuff to uniform it to drpm output
rout$Si           = aperm(rout$Si,       c(2, 1, 3))
rout$gamma        = aperm(rout$gamma,    c(2, 1, 3))
rout$sigma2h      = aperm(rout$sigma2h,  c(2, 1, 3))
rout$muh          = aperm(rout$muh,      c(2, 1, 3))
rout$fitted       = aperm(rout$fitted,   c(2, 1, 3))
rout$llike        = aperm(rout$llike,    c(2, 1, 3))
rout$alpha        = aperm(rout$alpha,    c(2, 1))
rout$theta        = aperm(rout$theta,    c(2, 1))
rout$tau2         = aperm(rout$tau2,     c(2, 1))
rout$eta1         = aperm(rout$eta1,    c(2, 1))
rout$phi0     = matrix(rout$phi0,    ncol = 1)
rout$phi1     = matrix(rout$phi1,    ncol = 1)
rout$lambda2  = matrix(rout$lambda2, ncol = 1)
cat(crayon::red("\nLPML =",rout$lpml, "\nWAIC =",rout$waic))
```

```{r}
# save(rout,file="./space NA/space_rout_NA_LK_ALT_better_dfweekly.Rdata")
save(rout,file="../3 Covaraites effects/space_rout_NA_LK_ALT_ECC_dfweekly.Rdata")
```


## Partition plots
```{r}
load("df wsc fits/space_rout_full_run6_dfweekly.Rdata")
rout_FULL = rout
# load("df wsc fits/space_rout_NA_run6_dfweekly.Rdata")
load("df wsc fits/space_rout_NA_run6e_dfweekly.Rdata")
# load("space NA/space_rout_NA_LK_ALT_better_dfweekly.Rdata")
# load("../3 Covaraites effects/NA lk improvement/space_rout_NA_LK_ALT_ECC_dfweekly.Rdata")
rout_NA = rout
```


```{r,warning=F}
# partition_plots = function(drpm1, rout){ 
# Initialize a list to store the partitions for each time instant
partitions_drpmj_NA <- generate_partition(rout_NA, loss ="binder",maxcl = 0)
partitions_drpmj_FL <- generate_partition(rout_FULL, loss ="binder",maxcl = 0)

save_plots=F

# partition_matrix <- do.call(cbind, partitions)
# if (save_plots==T){
# 	pdf(file="partizioni_chars.pdf",width=12,height = 6)
# }
# par(mar=c(4,1,3,1),mfrow=c(1,2),oma=c(1,0.5,0.5,0.5))
# plot_partition_with_chars(partitions_drpmc, title="model C")
# plot_partition_with_chars(partitions_drpmj, title="model J")
# if (save_plots==T){ dev.off()}

if (save_plots==T){
	pdf(file="ari.pdf",width=10,height = 5)
}
par(mar=c(2,2,2,2),mfrow=c(1,2),oma=c(0.1,0.1,0.1,2))
plot_ARI(partitions_drpmj_NA, title="model J (NA data)")
plot_ARI(partitions_drpmj_FL, title="model J (full data)")
if (save_plots==T){ dev.off()}


# if (save_plots==T){
# 	pdf(file="partizioni_nums.pdf",width=10,height = 4)
# 	# pdf(file="partizioni_nums_higher.pdf",width=10,height = 5)
# }
# par(mar=c(3.2,1,2,1),mfrow=c(1,2),oma=c(0.1,0.1,0.1,0.1))
# plot_partition_with_numbers(partitions_drpmj_NA, title="model J (NA data)",cex=1.5,line=2.1)
# plot_partition_with_numbers(partitions_drpmj_FL, title="model J (full data)",cex=1.5,line=2.1)
# if (save_plots==T){ dev.off()}
```





# fitted values

```{r}
yredORIG=y
save_plots=T

#################################################################
if (save_plots==TRUE) { 
	# pdf(file="J_mean_prediction_NApluslk.pdf",height = 5.7,width=11)
	pdf(file="J_mean_prediction_NA.pdf",height = 5.7,width=11)
	# pdf(file="J_median_prediction.pdf",height = 6,width=10)
	# pdf(file="J_last_iteration.pdf",height = 6,width=10)
}
summary_fitted_NA = t(rout_NA$fitted[,,size(rout_NA$fitted)[3]])*0
for(j in 1:N){
	for(t in 1:Tm){
		# values_j = c()
		# for (it in 1:size(rout_NA$fitted)[3]){
			# values_j = c(values_j,rout_NA$fitted[t,j,it])
		# }
		summary_fitted_NA[j,t] = mean(rout_NA$fitted[t,j,])
		# summary_fitted_NA[j,t] = median(values_j)
		# summary_fitted_NA[j,t] = Mode(values_j) # function from include.R
	}
}
yred_NA=summary_fitted_NA
# take last sample (maybe not the best choice)
# yred=t(rout$fitted[,,size(rout$fitted)[3]])

#########################
summary_fitted_FULL= t(rout_FULL$fitted[,,size(rout_FULL$fitted)[3]])*0
for(j in 1:N){
	for(t in 1:Tm){
		# values_j = c()
		# for (it in 1:size(rout_FULL$fitted)[3]){
			# values_j = c(values_j,rout_FULL$fitted[t,j,it])
		# }
		summary_fitted_FULL[j,t] = mean(rout_FULL$fitted[t,j,])
		# summary_fitted_FULL[j,t] = median(values_j)
		# summary_fitted_FULL[j,t] = Mode(values_j) # function from include.R
	}
}
yred_FULL=summary_fitted_FULL
#########################

par(mar=c(2,2,2,1))
cols = colora(size(yred)[1],56,0)
# cols = colora(N,"div",0)
# cols = colora(N,"div",seed_div = "Paired",show = 0)
for(i in 1:size(yred_NA)[1]){
   if(i==1){
     plot(1:size(yred_NA)[2],yred_NA[i,],col=cols[i],
     	 ylim=extrema(yredORIG,yred_FULL,yred_NA),type='l',xlab='',ylab="",
     	 # main="J fitted values - last iteration")
     	 main="J fitted values (NA data) - iterations mean")
     	 # main="J fitted values (NA data + lk covariates) - iterations mean")
     	 # main="J fitted values - iterations median")
 	  } 
	  else{
		  lines(1:size(yred_NA)[2],yred_NA[i,],col=cols[i])
	  }
}
cexs = 0.9
pch_diff = 18
for (k in 1:n_na){
		lines(c(na_indices_t[k],na_indices_t[k]),
		  # c(y[na_indices_j[k], na_indices_t[k]],yred[na_indices_j[k], na_indices_t[k]]),
		  c(yred_FULL[na_indices_j[k], na_indices_t[k]],
		    yred_NA[na_indices_j[k], na_indices_t[k]]),
		  col="#aaaaaa",lty=2)
	# points(na_indices_t[k],y[na_indices_j[k], na_indices_t[k]], col="#33aa33",pch=4)
	points(na_indices_t[k],yred_FULL[na_indices_j[k], na_indices_t[k]],
		   col="#009900",pch=pch_diff,cex=cexs)
	points(na_indices_t[k],yred_NA[na_indices_j[k], na_indices_t[k]],
		   col="#990000",pch=pch_diff,cex=cexs)

}
# legend("bottom",legend=c("fitted with NA data + lk covariates","fitted with full data"),
legend("bottom",legend=c("fitted with NA data","fitted with full data"),
	   col=c("#990000","#009900"),
	   pch=pch_diff,cex=cexs, bty="n")
if (save_plots==TRUE) { dev.off() }
#################################################################


yred=y
cols = colora(size(yred)[1],56,0)
# cols = colora(N,"div",seed_div = "Paired",show = 0)
if (save_plots==TRUE) { 
	pdf(file="test_2_spatial_data.pdf",height = 6,width=11)
}
par(mar=c(2,2,2,1))
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],ylim=extrema(yredORIG,yred_FULL,yred_NA)
     	 ,type='l',
     	 xlab='time',
     	 main='Spatio-temporal PM10 values')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}
# pchs
# offsets = c(-0.1,-0.2,0,0,0,0.2,0,0,0.1,0.3)
# for(i in 1:N){
# 	text(12.1,yred[i,12]+offsets[i],label=pchs[i],col=cols[i],cex=0.8)
# }
# offsets = c(-0.2,-0.4,0.1,0.7,0.82,-0.8,0,0,0.2,0.1)
# for(i in 1:N){
# 	text(0.92,yred[i,1]+offsets[i],label=pchs[i],col=cols[i],cex=0.8)
# }
# legend("bottom", legend = paste("unit", 1:size(yred)[1]), col = cols,
# 	   lty = 1,lwd=2,
# 	   cex=0.8, bty="n",
# 	   ncol=5)
if (save_plots==TRUE) { dev.off()}
```

# clusters
```{r}
yred=y
# cols = colora(N,"div",0)
cols = colora(N,56,0)
# cols = colora(N,"div",seed_div = "Paired",show = 0)

save_plots=F

# yred=y
# cols = colora(N,"div",0)
if (save_plots==TRUE) { 
	pdf(file="clusters_J.pdf",height = 6,width=11)
}
par(mar=c(2,2,2,1))
for(i in 1:size(yred)[1]){
   if(i==1){
     plot(1:size(yred)[2],yred[i,],col=cols[i],ylim=extrema(yred_NA,yredORIG),type='l',
     	 xlab='time',
     	 main='Clusters according to model J-DRPM (NA data)')
 	  } 
	  else{
		  lines(1:size(yred)[2],yred[i,],col=cols[i])
	  }
}

# partition = partitions_drpmc
partition = partitions_drpmj_NA
partition_matrix <- do.call(cbind, partition)
for(i in 1:N){
	for (t in 1:Tm){
		pchh = 19
		if (is.na(y_NA[i,t])){
			pchh = 8
			cexs = 1.2
		}
		else {
			pchh = 19
			cexs = 1
		}
		points(t,yred[i,t],col=partition_matrix[i, t],
			   pch=pchh,cex=cexs)
	}
}
if (save_plots==TRUE) { dev.off() }
```

```{r}
name = "JDRPM - NA data - target + space + covariates in the likelihood"
pdf(file=paste0("fit",name,"_simple_map.pdf"),height =7, width = 9)
par(mfrow=c(3,4),mar=c(1.5,2,2,1),oma=c(1,1,2,1))
for(t in 1:Tm){
	partition = partitions_drpmj
	partition_matrix <- do.call(cbind, partition)
	plot(s_std[1,1],s_std[1,2],col=partition_matrix[1,t],pch=19,
		 xlim=extrema(s_std[,1]),main=paste("time",t),
		 ylim=extrema(s_std[,2]),
		 # cex=((y[1,t]-mean(y[,t]))/sd(y[,t])+3)/2)
		 # cex=y[1,t]+abs(min(y[,t])))
		  cex=1.2)
	for (i in 1:N){
		points(s_std[i,1],s_std[i,2],col=partition_matrix[i,t],pch=19,
			   # cex=((y[i,t]-mean(y[,t]))/sd(y[,t])+3)/2)
			   # cex=y[i,t]+abs(min(y[,t])))
			    cex=1.2)
	}
}
# [1] "#070707" "#2E1831" "#402E56" "#404B7B" "#036D9B" "#0092B2" "#00AFB2" "#60C8B6"
 # [9] "#A8DFC5" "#E0F7E1"
mtext(name,side=3,line=0,outer=T,col="#2E1831")
dev.off()
```


# compute mse
```{r}
yredORIGI=y
MSE_matrices = function(m1,m2){
	MSE = 0
	for (i in 1:size(m1)[1]){
		for (t in 1:size(m1)[2]){
			MSE = MSE + (m1[i,t]-m2[i,t])^2
		}
	}
	MSE = MSE/(size(m1)[1]*size(m1)[2])
	return(MSE)
}

#################################################################
summary_fitted_mean = t(rout_NA$fitted[,,size(rout_NA$fitted)[3]])*0
summary_fitted_median = t(rout_NA$fitted[,,size(rout_NA$fitted)[3]])*0
for(j in 1:N){
	for(t in 1:Tm){
		# values_j = c()
		# for (it in 1:size(rout_NA$fitted)[3]){
			# values_j = c(values_j,rout_NA$fitted[t,j,it])
		# }
		summary_fitted_mean[j,t] = mean(rout_NA$fitted[t,j,])
		summary_fitted_median[j,t] = median(rout_NA$fitted[t,j,])
		# summary_fitted[j,t] = Mode(values_j) # function from include.R
	}
}
# take last sample (maybe not the best choice)
# yredJ=t(rout$fitted[,,size(rout$fitted)[3]])
#################################################################
cat("J NA MSE\n")
cat("mean ", MSE_matrices(summary_fitted_mean,yredORIGI),"\n")
cat("median ", MSE_matrices(summary_fitted_median,yredORIGI),"\n")
```

## ari pairwise
```{r,warning=F}
library(mclust)
LEN = Tm
compare_ARI = function(Cmod1,Jmod2){
	ARIvec <- matrix(NA, nrow=1, ncol=LEN)
		rhoC = generate_partition(Cmod1)
		rhoJ = generate_partition(Jmod2)
	for(k in 1: LEN){
		cat(k,"\r")
		ARIvec[k] <- adjustedRandIndex(rhoC[[k]][1:N], rhoJ[[k]][1:N])
	}	
	ncols_ari = 100
	cols_ARI = colora(ncols_ari,79,0)
	# cols_ARI = rev(cols_ARI)
	brks = seq(-1,1,length.out=ncols_ari+1)
	# pdf(paste0("./figures/DRPM/ARI/ari.pdf"), height=8, width=10)
	# svg(paste0("./figures/",base_folder,"/ARI/ari.svg"), height=8, width=10)
	# png(paste0("./figures/",base_folder,"/ARI/ari.png"),  width=700,height=600)
	library(fields)
	# plot(1:Tm,ARIvec,type="l",main=paste0("ARI values"),ylim=c(-0.5,1))
	par(mar=c(2,2,2,1))
	plot(1:Tm,ARIvec,type="l",
		 main=bquote("ARI values " * rho[J] * "(t) vs " * rho[C] * "(t)"),ylim=c(-0.5,1))
	abline(h=0,  col="#888888",lty=3,lwd=2)
	abline(h=0.5,col="#dddddd",lty=3,lwd=2)
	
	# image.plot(ARIvec,
	# 		   main=paste0("ARI values - ",mod1," vs ",mod2),axes=FALSE,col=cols_ARI,
	# 		   breaks=brks)
	# mtext(text=c(paste("",1:LEN)), side=2, line=0.3,at=seq(0,1,length=LEN), las=1, cex=0.8)
	return(ARIvec)
}

ariv = compare_ARI(rout_FULL,rout_NA)
cat("ARI\n")
cat("mean ",mean(ariv),"\n")
cat("median ",median(ariv))
```


# ===========


### beta
```{r}
rout = rout_NA

save_plots = F
# par(mar=c(0,0,0,0),oma=c(0.1,0.1,0.1,0.1))

par(mfrow=c(3,2),mar=c(2,2,2,1),oma=c(0.1,0.1,0.2,0.1))
for (covariata_idx in 1:length(covariate_scelte)){
# for (covariata_idx in 1:2){
	
	if (save_plots==T){
	pdf(file=paste0("beta_",covariate_scelte[covariata_idx],".pdf"),width=10,height = 5)
	}
	
	cols = colora(size(rout$beta)[3],44,0)
	cols = paste0(cols,"AA")
	# verde scuro: iterazioni iniziali
	# giallo: iterazioni finali
	# par(mar=c(3,3,3,1))
	# par(mar=c(2,2,2,1),oma=c(0.1,0.1,0.2,0.1))
	for (iter in 1:size(rout$beta)[3]){
		if(iter==1) {
			plot(rout$beta[,covariata_idx,iter],
				 ylim=extrema(rout$beta[,covariata_idx,]),
				 # main=covariate_scelte[covariata_idx],
				 main=bquote(beta[t] * " regressor - " * .(covariate_scelte[covariata_idx])),
				 col = cols[iter],type="l")
	# abline(h=0,col="gray40",lty=2)
		} else {
			lines(rout$beta[,covariata_idx,iter],col = cols[iter])
		}
	}
	legend("topleft",legend = c("initial iterates","final iterates"),
		   col = c(cols[1],cols[size(rout$beta)[3]]),lty=c(1,1),
		   lwd=3,cex=0.8,bty="n"
		   )
	# boxplot(rout$beta[,covariata_idx,],
		# main=covariate_scelte[covariata_idx])
if (save_plots==T) { dev.off() }
}
```


```{r}
rout = rout_NA

save_plots = T
# par(mar=c(0,0,0,0),oma=c(0.1,0.1,0.1,0.1))

	if (save_plots==T){
	pdf(file=paste0("beta_alls_and_alt.pdf"),width=10,height = 10)
	}

layout(mat = matrix(rbind(c(1,1),c(2,3),c(4,5)),ncol=2),
       heights = c(1,1,1), # Heights of the two rows
       widths = c(1,1)) # Widths of the two columns

# par(mfrow=c(2,2),mar=c(2,2,2,1),oma=c(0.1,0.1,0.2,0.1))
par(mar=c(2,2,2,1),oma=c(0.1,0.1,0.2,0.1))

for (covariata_idx in 1:length(covariate_scelte)){
# for (covariata_idx in 2:length(covariate_scelte)){

	cols = colora(size(rout$beta)[3],44,0)
	cols = paste0(cols,"AA")
	# verde scuro: iterazioni iniziali
	# giallo: iterazioni finali
	# par(mar=c(3,3,3,1))
	# par(mar=c(2,2,2,1),oma=c(0.1,0.1,0.2,0.1))
	for (iter in 1:size(rout$beta)[3]){
		if(iter==1) {
			plot(rout$beta[,covariata_idx,iter],
				 ylim=extrema(rout$beta[,covariata_idx,]),
				 # main=covariate_scelte[covariata_idx],
				 main=bquote(beta[t] * " regressor - " * .(covariate_scelte[covariata_idx])),
				 col = cols[iter],type="l")
	# abline(h=0,col="gray40",lty=2)
		} else {
			lines(rout$beta[,covariata_idx,iter],col = cols[iter])
		}
	}
	# boxplot(rout$beta[,covariata_idx,],
		# main=covariate_scelte[covariata_idx])
	legend("topleft",legend = c("initial iterates","final iterates"),
		   col = c(cols[1],cols[size(rout$beta)[3]]),lty=c(1,1),
		   lwd=3,cex=0.8,bty="n"
		   )
}
# plot.new()

if (save_plots==T) { dev.off() }
```


