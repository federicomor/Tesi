tau2_priors = c(a_tau,b_tau),
phi0_priors = c(m0_phi0,s20_phi0),
phi1_priors = sig_mh_phi1^2,
lambda2_priors = c(a_lambda,b_lambda),
alpha_priors = c(a_alpha,b_alpha),
######## space
spatial_cohesion_idx = spatial_cohesion,
sp_params = list(c(mu0,mu0),k0,1,matrix(c(L0,0.0,0.0,L0),nrow=2)),
######## likelihood covariates
# Xlk_covariates = X_lk, beta_priors = c(rep(0,p),1),
# Xlk_covariates = NA, beta_priors = NA,
######## clustering covariates
# covariate_similarity_idx = 4,
# cv_params = list(0,1,2,2),
# Xcl_covariates = X_cl,
# draws  = as.integer(niter), burnin = as.integer(nburn),thin   = as.integer(nthin),
draws = as.integer(100), burnin = 0, thin = 1,
logging = T,
seed = 43.0
)
# ym = as.matrix(y)
# sm = as.matrix(s_std)
module_JDRPM <- juliaImport(juliaCall("include", module))
out = module_JDRPM$MCMC_fit(
Y=y,
sp_coords = s_std,
M_dp = 1,
initial_partition = NA,
starting_alpha = 0.5,
unit_specific_alpha = FALSE,
time_specific_alpha = time_specific_alpha,
update_alpha = TRUE,
include_eta1 = TRUE,
include_phi1 = TRUE,
update_eta1 = update_eta1,
update_phi1 = update_phi1,
sig2h_priors = c(a_sigma,b_sigma),
eta1_priors = c(eta1_scale,sig_mh_eta1^2),
tau2_priors = c(a_tau,b_tau),
phi0_priors = c(m0_phi0,s20_phi0),
phi1_priors = sig_mh_phi1^2,
lambda2_priors = c(a_lambda,b_lambda),
alpha_priors = c(a_alpha,b_alpha),
######## space
spatial_cohesion_idx = spatial_cohesion,
sp_params = list(c(mu0,mu0),k0,1,matrix(c(L0,0.0,0.0,L0),nrow=2)),
######## likelihood covariates
# Xlk_covariates = X_lk, beta_priors = c(rep(0,p),1),
# Xlk_covariates = NA, beta_priors = NA,
######## clustering covariates
# covariate_similarity_idx = 4,
# cv_params = list(0,1,2,2),
# Xcl_covariates = X_cl,
# draws  = as.integer(niter), burnin = as.integer(nburn),thin   = as.integer(nthin),
draws = as.integer(100), burnin = 0, thin = 1,
logging = T,
seed = 43.0
)
tempo_inizio <- Sys.time()
drpm1 <- drpm_fit(
y=y,
s_coords = s_std,
M=1,
initial_partition = NULL,
starting_alpha = 0.5,
unit_specific_alpha = FALSE,
time_specific_alpha = time_specific_alpha,
alpha_0=FALSE,
eta1_0=!(update_eta1),
phi1_0=!(update_phi1),
# modelPriors=c(0,100^2,1,1,1,1), # original default one
modelPriors=c(m0_phi0,s20_phi0,A_ub_sigma,A_ub_tau,A_ub_lambda,eta1_scale),
alphaPriors=rbind(c(a_alpha,b_alpha)), # if time_specific_alpha == TRUE
simpleModel = 0,
theta_tau2 = c(0, 2), # only used if simpleModel=1
SpatialCohesion=spatial_cohesion, # auxiliary similarity
# SpatialCohesion=4, # double dipper similarity
cParms=c(mu0, k0, 1, L0),
mh=c(sig_mh_sig2,sig_mh_tau2,sig_mh_lambda2,sig_mh_eta1,sig_mh_phi1),
verbose=TRUE,
# draws=1000,burn=0,thin=1)
draws=niter,burn=nburn,thin=nthin)
tempo_fine <- Sys.time()
differenza_tempo <- tempo_fine - tempo_inizio
cat(crayon::cyan("Fit took:\n"))
print(round(differenza_tempo,digits = 4))
cat(crayon::red("\nLPML =",drpm1$lpml, "\nWAIC =",drpm1$waic))
devtools::load_all("../../drpm_main/")
# devtools::load_all("../../drpm_sporcato//")
tempo_inizio <- Sys.time()
drpm1 <- drpm_fit(
y=y,
s_coords = s_std,
M=1,
initial_partition = NULL,
starting_alpha = 0.5,
unit_specific_alpha = FALSE,
time_specific_alpha = time_specific_alpha,
alpha_0=FALSE,
eta1_0=!(update_eta1),
phi1_0=!(update_phi1),
# modelPriors=c(0,100^2,1,1,1,1), # original default one
modelPriors=c(m0_phi0,s20_phi0,A_ub_sigma,A_ub_tau,A_ub_lambda,eta1_scale),
alphaPriors=rbind(c(a_alpha,b_alpha)), # if time_specific_alpha == TRUE
simpleModel = 0,
theta_tau2 = c(0, 2), # only used if simpleModel=1
SpatialCohesion=spatial_cohesion, # auxiliary similarity
# SpatialCohesion=4, # double dipper similarity
cParms=c(mu0, k0, 1, L0),
mh=c(sig_mh_sig2,sig_mh_tau2,sig_mh_lambda2,sig_mh_eta1,sig_mh_phi1),
verbose=TRUE,
# draws=1000,burn=0,thin=1)
draws=niter,burn=nburn,thin=nthin)
devtools::load_all("../../drpm_main/")
# devtools::load_all("../../drpm_sporcato//")
tempo_inizio <- Sys.time()
drpm1 <- drpm_fit(
y=y,
s_coords = s_std,
M=1,
initial_partition = NULL,
starting_alpha = 0.5,
unit_specific_alpha = FALSE,
time_specific_alpha = time_specific_alpha,
alpha_0=FALSE,
eta1_0=!(update_eta1),
phi1_0=!(update_phi1),
# modelPriors=c(0,100^2,1,1,1,1), # original default one
modelPriors=c(m0_phi0,s20_phi0,A_ub_sigma,A_ub_tau,A_ub_lambda,eta1_scale),
alphaPriors=rbind(c(a_alpha,b_alpha)), # if time_specific_alpha == TRUE
simpleModel = 0,
theta_tau2 = c(0, 2), # only used if simpleModel=1
SpatialCohesion=spatial_cohesion, # auxiliary similarity
# SpatialCohesion=4, # double dipper similarity
cParms=c(mu0, k0, 1, L0),
mh=c(sig_mh_sig2,sig_mh_tau2,sig_mh_lambda2,sig_mh_eta1,sig_mh_phi1),
verbose=TRUE,
draws=100,burn=0,thin=1)
devtools::load_all("../../drpm_main/")
# devtools::load_all("../../drpm_sporcato//")
tempo_inizio <- Sys.time()
drpm1 <- drpm_fit(
y=y,
s_coords = s_std,
M=1,
initial_partition = NULL,
starting_alpha = 0.5,
unit_specific_alpha = FALSE,
time_specific_alpha = time_specific_alpha,
alpha_0=FALSE,
eta1_0=!(update_eta1),
phi1_0=!(update_phi1),
# modelPriors=c(0,100^2,1,1,1,1), # original default one
modelPriors=c(m0_phi0,s20_phi0,A_ub_sigma,A_ub_tau,A_ub_lambda,eta1_scale),
alphaPriors=rbind(c(a_alpha,b_alpha)), # if time_specific_alpha == TRUE
simpleModel = 0,
theta_tau2 = c(0, 2), # only used if simpleModel=1
SpatialCohesion=spatial_cohesion, # auxiliary similarity
# SpatialCohesion=4, # double dipper similarity
cParms=c(mu0, k0, 1, L0),
mh=c(sig_mh_sig2,sig_mh_tau2,sig_mh_lambda2,sig_mh_eta1,sig_mh_phi1),
verbose=TRUE,
draws=4,burn=0,thin=1)
# draws=niter,burn=nburn,thin=nthin)
tempo_fine <- Sys.time()
differenza_tempo <- tempo_fine - tempo_inizio
cat(crayon::cyan("Fit took:\n"))
print(round(differenza_tempo,digits = 4))
cat(crayon::red("\nLPML =",drpm1$lpml, "\nWAIC =",drpm1$waic))
devtools::load_all("../../drpm_main/")
# devtools::load_all("../../drpm_sporcato//")
tempo_inizio <- Sys.time()
drpm1 <- drpm_fit(
y=y,
s_coords = s_std,
M=1,
initial_partition = NULL,
starting_alpha = 0.5,
unit_specific_alpha = FALSE,
time_specific_alpha = time_specific_alpha,
alpha_0=FALSE,
eta1_0=!(update_eta1),
phi1_0=!(update_phi1),
# modelPriors=c(0,100^2,1,1,1,1), # original default one
modelPriors=c(m0_phi0,s20_phi0,A_ub_sigma,A_ub_tau,A_ub_lambda,eta1_scale),
alphaPriors=rbind(c(a_alpha,b_alpha)), # if time_specific_alpha == TRUE
simpleModel = 0,
theta_tau2 = c(0, 2), # only used if simpleModel=1
SpatialCohesion=spatial_cohesion, # auxiliary similarity
# SpatialCohesion=4, # double dipper similarity
cParms=c(mu0, k0, 1, L0),
mh=c(sig_mh_sig2,sig_mh_tau2,sig_mh_lambda2,sig_mh_eta1,sig_mh_phi1),
verbose=TRUE,
draws=4,burn=0,thin=1)
# draws=niter,burn=nburn,thin=nthin)
tempo_fine <- Sys.time()
differenza_tempo <- tempo_fine - tempo_inizio
cat(crayon::cyan("Fit took:\n"))
print(round(differenza_tempo,digits = 4))
cat(crayon::red("\nLPML =",drpm1$lpml, "\nWAIC =",drpm1$waic))
drpm1$gamma
load("../thesis data/df_wsc.Rdata")
na_summary(df_wsc)
sites = std_sites = data.frame(
longitude = unique(df_wsc$Longitude),
latitude = unique(df_wsc$Latitude))
stations = unique(df_wsc$IDStations)
yfull=data.frame()
target = "AQ_pm10"
# target = "WE_tot_precipitation"
for(st in stations){
y_we_pm10=cbind(as.data.frame(st),t(df_wsc[which(df_wsc$IDStations==st),target]))
yfull=rbind(yfull,y_we_pm10)
}
rownames(yfull) = NULL
colnames(yfull)<- c("id",paste0("w", 1:53))
time_span = 1:10
for (seed in 1:20){
set.seed(seed)
quanti = 50; nsubjects = sample(1:105, quanti,replace = F)
# nsubjects = 1:105
y = yfull[nsubjects,1+time_span]
par(mar=c(2,2,2,1))
yred=y[,time_span]
# par(mar=c(4,4,2,2))
cols = colora(size(yred)[1],56,0)
for(i in 1:size(yred)[1]){
if(i==1){
plot(1:size(yred)[2],yred[i,],col=cols[i],
ylim=extrema(as.matrix(yfull[,-c(1)])),
type='l',xlab='weeks',ylab='pm10',main=seed)
}
else{
lines(1:size(yred)[2],yred[i,],col=cols[i])
}
}
# for(i in 1:N){
# 	text(1,yred[i,1],i,cex=0.7)
# }
}
set.seed(14)
# quanti = 50; nsubjects = sample(1:105, quanti,replace = F)
quanti = 10; nsubjects = sample(1:105, quanti,replace = F)
# nsubjects = 1:105
y = yfull[nsubjects,1+time_span]
#############################################
# authors suggested to/did scale the spatial locations and also centered the observations
mn <- apply(y,2,mean)
sd <- apply(y,2,sd)
y <- t(t(y) - mn)
Tm = tps <- ncol(y) # time span
N = size(y)[1] # number of units
num_units = N
sites = sites[nsubjects,]
smn <- apply(sites,2,mean)
ssd <- apply(sites,2,sd)
s_std <- t((t(sites) - smn)/ssd)
# check
# mean(s_std[,1])
# mean(s_std[,2])
# var(s_std[,2])
# var(s_std[,1])
######################################
par(mar=c(2,2,2,1))
yred=y[,time_span]
# par(mar=c(4,4,2,2))
cols = colora(size(yred)[1],56,0)
for(i in 1:size(yred)[1]){
if(i==1){
plot(1:size(yred)[2],yred[i,],col=cols[i],
ylim=extrema(as.matrix(yfull[,-c(1)])),
type='l',xlab='weeks',ylab='pm10',main=seed)
}
else{
lines(1:size(yred)[2],yred[i,],col=cols[i])
}
}
# for(i in 1:N){
# 	text(1,yred[i,1],i,cex=0.7)
# }
# -> we have
y
s_std
plot(s_std)
rownames(s_std) = NULL
set.seed(14)
# quanti = 50; nsubjects = sample(1:105, quanti,replace = F)
quanti = 20; nsubjects = sample(1:105, quanti,replace = F)
# nsubjects = 1:105
y = yfull[nsubjects,1+time_span]
#############################################
# authors suggested to/did scale the spatial locations and also centered the observations
mn <- apply(y,2,mean)
sd <- apply(y,2,sd)
y <- t(t(y) - mn)
Tm = tps <- ncol(y) # time span
N = size(y)[1] # number of units
num_units = N
sites = sites[nsubjects,]
smn <- apply(sites,2,mean)
ssd <- apply(sites,2,sd)
s_std <- t((t(sites) - smn)/ssd)
# check
# mean(s_std[,1])
# mean(s_std[,2])
# var(s_std[,2])
# var(s_std[,1])
######################################
par(mar=c(2,2,2,1))
yred=y[,time_span]
# par(mar=c(4,4,2,2))
cols = colora(size(yred)[1],56,0)
for(i in 1:size(yred)[1]){
if(i==1){
plot(1:size(yred)[2],yred[i,],col=cols[i],
ylim=extrema(as.matrix(yfull[,-c(1)])),
type='l',xlab='weeks',ylab='pm10',main=seed)
}
else{
lines(1:size(yred)[2],yred[i,],col=cols[i])
}
}
# for(i in 1:N){
# 	text(1,yred[i,1],i,cex=0.7)
# }
# -> we have
y
s_std
plot(s_std)
set.seed(14)
# quanti = 50; nsubjects = sample(1:105, quanti,replace = F)
quanti = 20; nsubjects = sample(1:105, quanti,replace = F)
# nsubjects = 1:105
y = yfull[nsubjects,1+time_span]
#############################################
# authors suggested to/did scale the spatial locations and also centered the observations
mn <- apply(y,2,mean)
sd <- apply(y,2,sd)
y <- t(t(y) - mn)
Tm = tps <- ncol(y) # time span
N = size(y)[1] # number of units
num_units = N
sites = sites[nsubjects,]
smn <- apply(sites,2,mean)
ssd <- apply(sites,2,sd)
s_std <- t((t(sites) - smn)/ssd)
# check
# mean(s_std[,1])
# mean(s_std[,2])
# var(s_std[,2])
# var(s_std[,1])
######################################
par(mar=c(2,2,2,1))
yred=y[,time_span]
# par(mar=c(4,4,2,2))
cols = colora(size(yred)[1],56,0)
for(i in 1:size(yred)[1]){
if(i==1){
plot(1:size(yred)[2],yred[i,],col=cols[i],
ylim=extrema(as.matrix(yfull[,-c(1)])),
type='l',xlab='weeks',ylab='pm10',main=seed)
}
else{
lines(1:size(yred)[2],yred[i,],col=cols[i])
}
}
# for(i in 1:N){
# 	text(1,yred[i,1],i,cex=0.7)
# }
# -> we have
y
s_std
plot(s_std)
sites = std_sites = data.frame(
longitude = unique(df_wsc$Longitude),
latitude = unique(df_wsc$Latitude))
stations = unique(df_wsc$IDStations)
yfull=data.frame()
target = "AQ_pm10"
# target = "WE_tot_precipitation"
for(st in stations){
y_we_pm10=cbind(as.data.frame(st),t(df_wsc[which(df_wsc$IDStations==st),target]))
yfull=rbind(yfull,y_we_pm10)
}
rownames(yfull) = NULL
colnames(yfull)<- c("id",paste0("w", 1:53))
time_span = 1:10
set.seed(14)
# quanti = 50; nsubjects = sample(1:105, quanti,replace = F)
quanti = 20; nsubjects = sample(1:105, quanti,replace = F)
# nsubjects = 1:105
y = yfull[nsubjects,1+time_span]
#############################################
# authors suggested to/did scale the spatial locations and also centered the observations
mn <- apply(y,2,mean)
sd <- apply(y,2,sd)
y <- t(t(y) - mn)
Tm = tps <- ncol(y) # time span
N = size(y)[1] # number of units
num_units = N
sites = sites[nsubjects,]
smn <- apply(sites,2,mean)
ssd <- apply(sites,2,sd)
s_std <- t((t(sites) - smn)/ssd)
# check
# mean(s_std[,1])
# mean(s_std[,2])
# var(s_std[,2])
# var(s_std[,1])
######################################
par(mar=c(2,2,2,1))
yred=y[,time_span]
# par(mar=c(4,4,2,2))
cols = colora(size(yred)[1],56,0)
for(i in 1:size(yred)[1]){
if(i==1){
plot(1:size(yred)[2],yred[i,],col=cols[i],
ylim=extrema(as.matrix(yfull[,-c(1)])),
type='l',xlab='weeks',ylab='pm10',main=seed)
}
else{
lines(1:size(yred)[2],yred[i,],col=cols[i])
}
}
# for(i in 1:N){
# 	text(1,yred[i,1],i,cex=0.7)
# }
# -> we have
y
s_std
plot(s_std)
rownames(s_std) = NULL
# as.integer(runif(1,0,1000))*1.0
# seed = 881.0
seed = 314.0
cat("seed",seed,"\n")
# niter=10000; nburn=6000; nthin=4
# niter=50000; nburn=10000; nthin=40 # they did this in their tests
# niter=30000; nburn=20000; nthin=10
niter=50000; nburn=30000; nthin=20
# niter=80000; nburn=60000; nthin=20
# niter=100000; nburn=60000; nthin=40
nout <- (niter-nburn)/nthin
cat(nout,"valid iterations\n")
niter = as.integer(niter)
nburn = as.integer(nburn)
nthin = as.integer(nthin)
# params
m0_phi0 = 0
s20_phi0 = 10
A_ub_sigma = 5
A_ub_tau = 5
A_ub_lambda = 5
a_sigma  = 2; b_sigma  = 2
a_tau    = 2; b_tau    = 2
a_lambda = 2; b_lambda = 2
eta1_scale = 1
# mh is the of gaussian standard deviations for metropolis updates
# So these are not variances!
sig_mh_sig2 = 0.3
sig_mh_tau2 = 0.3
sig_mh_lambda2 = 0.3
sig_mh_eta1 = 0.1
sig_mh_phi1 = 0.1
update_eta1 = TRUE
update_phi1 = TRUE
a_alpha = 2; b_alpha = 2
time_specific_alpha = TRUE
# now space
spatial_cohesion = as.integer(3)
mu0 = 0
k0 = 1
v0 = 5
L0 = 1
# params
m0_phi0 = 0
s20_phi0 = 10
A_ub_sigma = 5
A_ub_tau = 5
A_ub_lambda = 5
a_sigma  = 2; b_sigma  = 2
a_tau    = 2; b_tau    = 2
a_lambda = 2; b_lambda = 2
eta1_scale = 0.9
# mh is the of gaussian standard deviations for metropolis updates
# So these are not variances!
sig_mh_sig2 = 0.3
sig_mh_tau2 = 0.3
sig_mh_lambda2 = 0.3
sig_mh_eta1 = 0.1
sig_mh_phi1 = 0.1
update_eta1 = TRUE
update_phi1 = TRUE
a_alpha = 2; b_alpha = 2
time_specific_alpha = TRUE
# now space
spatial_cohesion = as.integer(3)
mu0 = 0
k0 = 1
v0 = 5
L0 = 1
# ym = as.matrix(y)
# sm = as.matrix(s_std)
module_JDRPM <- juliaImport(juliaCall("include", module))
library(JuliaConnectoR)
juliaSetupOk()
# juliaEval("using Pkg")
# juliaEval("Pkg.activate(\"../../JDRPM\")")
# juliaEval("Pkg.instantiate()")
# juliaEval("Pkg.status()")
# setup project
juliaEval("using Pkg; Pkg.status()")
